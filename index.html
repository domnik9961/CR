<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ReportForge — Kreator Definicji CR</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:ital,wght@0,400;0,500;1,400&family=Epilogue:wght@400;500;600;700&display=swap');

/* ══════════ CSS VARS ══════════ */
:root{
  --bg:#f0f2f8;
  --bg2:#e8ebf4;
  --surface:#ffffff;
  --surface2:#f6f7fb;
  --surface3:#eceef6;
  --border:#d8dce8;
  --border2:#c5cadc;
  --a:#2563eb;          /* blue accent */
  --a-l:#dbeafe;
  --a-d:#1d4ed8;
  --g:#059669;          /* green - complete */
  --g-l:#d1fae5;
  --y:#d97706;          /* yellow - partial */
  --y-l:#fef3c7;
  --r:#dc2626;          /* red/danger */
  --r-l:#fee2e2;
  --txt:#0f172a;
  --txt2:#334155;
  --muted:#64748b;
  --color-success-bg:var(--g-l);
  --color-warning-bg:var(--y-l);
  --color-info-bg:var(--a-l);
  --surface-elevated:linear-gradient(135deg,var(--a),var(--a-d));
  --surface-overlay:var(--txt);
  --sidebar-w:260px;
  --sidebar-collapsed:64px;
  --summary-w:320px;
  --topbar-h:56px;
  --radius:12px;
  --radius-sm:8px;
  --shadow:0 1px 3px rgba(15,23,42,.06),0 4px 12px rgba(15,23,42,.04);
  --shadow-md:0 4px 20px rgba(37,99,235,.1),0 1px 4px rgba(37,99,235,.06);
  --shadow-lg:0 20px 60px rgba(15,23,42,.15);
  --trans:.22s cubic-bezier(.4,0,.2,1);
  --bounce:.35s cubic-bezier(.34,1.56,.64,1);
}

body.theme-dark{
  --bg:#0b1220;
  --bg2:#10192b;
  --surface:#111827;
  --surface2:#1f2937;
  --surface3:#0f172a;
  --border:#334155;
  --border2:#475569;
  --a:#60a5fa;
  --a-l:#1e3a8a;
  --a-d:#3b82f6;
  --g:#34d399;
  --g-l:#064e3b;
  --y:#f59e0b;
  --y-l:#78350f;
  --r:#f87171;
  --r-l:#7f1d1d;
  --txt:#e2e8f0;
  --txt2:#cbd5e1;
  --muted:#94a3b8;
  --color-success-bg:#064e3b;
  --color-warning-bg:#78350f;
  --color-info-bg:#1e3a8a;
  --surface-elevated:linear-gradient(135deg,#60a5fa,#3b82f6);
  --surface-overlay:#020617;
  --shadow:0 1px 3px rgba(0,0,0,.35),0 4px 12px rgba(0,0,0,.25);
  --shadow-md:0 8px 24px rgba(0,0,0,.38);
  --shadow-lg:0 20px 60px rgba(0,0,0,.5);
}

/* ══════════ RESET & BASE ══════════ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{
  background:var(--bg);
  color:var(--txt);
  font-family:'Epilogue',sans-serif;
  font-size:14px;
  min-height:100vh;
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
}

/* ══════════ PAGE LOAD ANIMATION ══════════ */
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
@keyframes slideInLeft{from{opacity:0;transform:translateX(-30px)}to{opacity:1;transform:none}}
@keyframes slideInRight{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:none}}
@keyframes scaleIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:none}}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 0 0 rgba(37,99,235,.3)}50%{box-shadow:0 0 0 8px rgba(37,99,235,0)}}
@keyframes shimmer{from{background-position:200% 0}to{background-position:-200% 0}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes checkPop{0%{transform:scale(0) rotate(-45deg);opacity:0}60%{transform:scale(1.2) rotate(5deg)}100%{transform:scale(1) rotate(0);opacity:1}}
@keyframes dotPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.4)}}
@keyframes toastIn{from{opacity:0;transform:translateY(20px) scale(.9)}to{opacity:1;transform:none}}
@keyframes toastOut{from{opacity:1;transform:none}to{opacity:0;transform:translateY(-10px) scale(.95)}}
@keyframes tabPaneFade{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
@keyframes progressFill{from{width:0}to{width:var(--target-width,0%)}}

/* ══════════ TOPBAR ══════════ */
.topbar{
  position:fixed;top:0;left:0;right:0;z-index:200;
  height:var(--topbar-h);
  background:rgba(255,255,255,.92);
  backdrop-filter:blur(16px);
  -webkit-backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:0;
  box-shadow:var(--shadow);
  animation:fadeUp .4s ease both;
}
.topbar-brand{
  display:flex;align-items:center;gap:10px;
  padding:0 20px;height:100%;
  border-right:1px solid var(--border);
  min-width:var(--sidebar-w);
  transition:min-width var(--trans);
  text-decoration:none;
}
.body-sidebar-collapsed .topbar-brand{min-width:var(--sidebar-collapsed);}
.brand-logo{
  width:32px;height:32px;flex-shrink:0;
  background:linear-gradient(135deg,var(--a) 0%,#7c3aed 100%);
  border-radius:9px;display:grid;place-items:center;
  color:#fff;font-size:15px;
  box-shadow:0 4px 12px rgba(37,99,235,.35);
}
.brand-text{
  font-family:'Syne',sans-serif;font-size:16px;font-weight:800;
  color:var(--txt);letter-spacing:-.5px;white-space:nowrap;
  overflow:hidden;transition:opacity var(--trans),max-width var(--trans);
}
.brand-text span{color:var(--a);}
.body-sidebar-collapsed .brand-text{max-width:0;opacity:0;overflow:hidden;}
.topbar-center{flex:1;display:flex;align-items:center;padding:0 20px;gap:14px;}

/* Global progress bar in topbar */
.global-progress{
  flex:1;max-width:340px;
  background:var(--surface3);border-radius:20px;height:6px;overflow:hidden;
  position:relative;
}
.global-progress-fill{
  height:100%;border-radius:20px;
  background:linear-gradient(90deg,var(--a),#7c3aed,var(--g));
  background-size:200% 100%;
  animation:shimmer 3s linear infinite;
  transition:width .6s cubic-bezier(.4,0,.2,1);
  position:relative;
}
.global-progress-fill::after{
  content:'';position:absolute;right:0;top:50%;transform:translateY(-50%);
  width:10px;height:10px;border-radius:50%;
  background:#fff;border:2px solid var(--a);
  box-shadow:0 0 0 3px rgba(37,99,235,.2);
}
.progress-label{font-size:12px;font-weight:700;color:var(--muted);white-space:nowrap;font-family:'JetBrains Mono',monospace;}

.topbar-right{display:flex;align-items:center;gap:8px;padding-right:16px;}
.theme-switch{
  display:flex;align-items:center;
  border:1.5px solid var(--border);
  border-radius:999px;
  padding:2px;
  background:var(--surface2);
}
.theme-switch-btn{
  border:none;
  background:transparent;
  color:var(--muted);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  font-weight:700;
  display:flex;align-items:center;gap:6px;
  cursor:pointer;
}
.theme-switch-btn.active{
  background:var(--surface-elevated);
  color:#fff;
}
.tb-btn{
  display:flex;align-items:center;gap:6px;
  padding:7px 14px;border-radius:var(--radius-sm);
  font-size:12.5px;font-weight:600;cursor:pointer;
  transition:all var(--trans);border:1.5px solid var(--border);
  background:var(--surface2);color:var(--muted);
  font-family:'Epilogue',sans-serif;
  white-space:nowrap;
}
.tb-btn:hover{border-color:var(--a);color:var(--a);background:var(--a-l);transform:translateY(-1px);}
.tb-btn.primary{
  background:linear-gradient(135deg,var(--a),var(--a-d));
  color:#fff;border-color:transparent;
  box-shadow:0 4px 12px rgba(37,99,235,.3);
}
.tb-btn.primary:hover{box-shadow:0 6px 20px rgba(37,99,235,.4);transform:translateY(-2px);}

/* Sidebar toggle btn */
.sidebar-toggle{
  width:36px;height:36px;border-radius:var(--radius-sm);
  background:none;border:1.5px solid var(--border);
  color:var(--muted);cursor:pointer;
  display:grid;place-items:center;font-size:14px;
  transition:all var(--trans);flex-shrink:0;margin-left:4px;
}
.sidebar-toggle:hover{background:var(--a-l);border-color:var(--a);color:var(--a);}

/* Summary toggle btn with glow */
.summary-toggle-btn{
  position:relative;
}
.summary-toggle-btn::before{
  content:'';position:absolute;inset:-3px;border-radius:12px;
  background:linear-gradient(135deg,var(--a),#7c3aed);
  opacity:0;z-index:-1;transition:opacity var(--trans);
}
.summary-toggle-btn.active::before{opacity:.2;}

/* ══════════ LAYOUT SHELL ══════════ */
.shell{
  display:flex;
  margin-top:var(--topbar-h);
  min-height:calc(100vh - var(--topbar-h));
  transition:all var(--trans);
}

/* ══════════ SIDEBAR NAV ══════════ */
.sidebar{
  width:var(--sidebar-w);
  flex-shrink:0;
  background:var(--surface);
  border-right:1px solid var(--border);
  position:fixed;
  top:var(--topbar-h);bottom:0;left:0;
  overflow:hidden;
  transition:width var(--trans);
  z-index:150;
  display:flex;flex-direction:column;
  box-shadow:2px 0 12px rgba(15,23,42,.04);
  animation:slideInLeft .4s .1s ease both;
}
.body-sidebar-collapsed .sidebar{width:var(--sidebar-collapsed);}
.sidebar-inner{
  flex:1;overflow-y:auto;overflow-x:hidden;
  padding:12px 8px;
  scrollbar-width:thin;scrollbar-color:var(--border) transparent;
}
.sidebar-section-label{
  font-family:'Syne',sans-serif;
  font-size:9px;font-weight:700;letter-spacing:1.2px;
  text-transform:uppercase;color:var(--muted);
  padding:10px 10px 4px;white-space:nowrap;
  overflow:hidden;
  transition:opacity var(--trans);
}
.body-sidebar-collapsed .sidebar-section-label{opacity:0;}

/* TAB BUTTON */
.tab-btn{
  display:flex;align-items:center;gap:10px;
  padding:9px 10px;border-radius:10px;
  cursor:pointer;transition:all var(--trans);
  font-size:13px;font-weight:600;color:var(--muted);
  border:none;background:none;width:100%;text-align:left;
  position:relative;overflow:hidden;white-space:nowrap;
  font-family:'Epilogue',sans-serif;
  margin-bottom:2px;
}
.tab-btn::before{
  content:'';position:absolute;inset:0;border-radius:10px;
  background:linear-gradient(135deg,var(--a),#7c3aed);
  opacity:0;transition:opacity var(--trans);
}
.tab-btn.active{color:#fff;}
.tab-btn.active::before{opacity:1;}
.tab-btn:not(.active):hover{background:var(--surface2);color:var(--txt);}

.tab-ico{
  width:28px;height:28px;border-radius:7px;
  display:grid;place-items:center;font-size:13px;
  flex-shrink:0;transition:all var(--trans);
  position:relative;z-index:1;
}
.tab-btn:not(.active) .tab-ico{background:var(--surface3);color:var(--muted);}
.tab-btn.active .tab-ico{background:rgba(255,255,255,.2);color:#fff;}

.tab-label{position:relative;z-index:1;flex:1;overflow:hidden;text-overflow:ellipsis;}

/* STATUS DOT — completion indicator */
.tab-status{
  width:8px;height:8px;border-radius:50%;
  flex-shrink:0;position:relative;z-index:1;
  transition:all var(--bounce);
}
.tab-status.none{background:var(--border2);}
.tab-status.partial{background:var(--y);animation:dotPulse 2s ease-in-out infinite;}
.tab-status.complete{background:var(--g);}
.tab-btn.active .tab-status.none{background:rgba(255,255,255,.35);}
.tab-btn.active .tab-status.partial{background:#fbbf24;}
.tab-btn.active .tab-status.complete{background:#34d399;}

/* Collapsed: show only icon + status */
.body-sidebar-collapsed .tab-label,
.body-sidebar-collapsed .sidebar-section-label{
  max-width:0;opacity:0;overflow:hidden;
}
.body-sidebar-collapsed .tab-btn{justify-content:center;padding:9px;}
.body-sidebar-collapsed .tab-status{
  position:absolute;top:6px;right:6px;width:7px;height:7px;
}

/* Sidebar tooltip on hover when collapsed */
.body-sidebar-collapsed .tab-btn:hover .tab-label{
  max-width:none;opacity:1;
  position:absolute;left:56px;
  background:var(--txt);color:#fff;
  padding:5px 10px;border-radius:8px;
  font-size:12px;
  pointer-events:none;
  white-space:nowrap;z-index:999;
  animation:fadeUp .15s ease;
  box-shadow:var(--shadow-md);
}

/* Sidebar footer */
.sidebar-footer{
  padding:10px 8px;border-top:1px solid var(--border);
  display:flex;flex-direction:column;gap:6px;
}
.sidebar-footer-btn{
  display:flex;align-items:center;gap:8px;
  padding:8px 10px;border-radius:8px;
  font-size:12.5px;font-weight:600;cursor:pointer;
  transition:all var(--trans);border:none;background:none;
  color:var(--muted);width:100%;white-space:nowrap;
  font-family:'Epilogue',sans-serif;
}
.sidebar-footer-btn:hover{background:var(--surface2);color:var(--txt);}
.sidebar-footer-btn i{font-size:15px;flex-shrink:0;width:28px;text-align:center;}
.body-sidebar-collapsed .sidebar-footer-btn{justify-content:center;padding:8px;}

/* ══════════ MAIN CONTENT ══════════ */
.main{
  flex:1;
  margin-left:var(--sidebar-w);
  margin-right:0;
  transition:margin var(--trans);
  min-width:0;
}
.body-sidebar-collapsed .main{margin-left:var(--sidebar-collapsed);}

.tab-content{
  padding:28px 32px 100px;
  max-width:1100px;
  margin:0 auto;
}

.quick-actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin:0 auto 14px;
  max-width:1100px;
  padding:0 32px;
}
.quick-action-chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  border:none;
  border-radius:999px;
  padding:8px 14px;
  font-size:12px;
  font-weight:700;
  cursor:pointer;
  transition:transform var(--trans),filter var(--trans),box-shadow var(--trans);
  box-shadow:var(--shadow);
}
.quick-action-chip i{font-size:13px;}
.quick-action-chip:hover{transform:translateY(-1px);filter:brightness(.98);}
.quick-action-chip:focus-visible{outline:2px solid var(--a);outline-offset:2px;}
.quick-action-chip.lightning{background:var(--a-l);color:var(--a);}
.quick-action-chip.warning{background:var(--y-l);color:var(--y);}
.quick-action-chip.success{background:var(--g-l);color:var(--g);}

/* Tab pane animation */
.tab-pane{display:none;}
.tab-pane.active{
  display:block;
  animation:tabPaneFade .3s ease both;
}

/* ══════════ SUMMARY PANEL ══════════ */
.summary-panel{
  position:fixed;top:var(--topbar-h);right:0;bottom:0;
  width:var(--summary-w);
  background:var(--surface);
  border-left:1px solid var(--border);
  transform:translateX(100%);
  opacity:0;
  pointer-events:none;
  will-change:transform,opacity;
  z-index:260;
  display:flex;flex-direction:column;
  box-shadow:-4px 0 24px rgba(15,23,42,.08);
}
.body-summary-open .summary-panel{
  transform:translateX(0);
  opacity:1;
  pointer-events:auto;
  animation:summaryPanelIn .24s cubic-bezier(.2,.7,.2,1) both;
}
.body-summary-closing .summary-panel{
  transform:translateX(100%);
  opacity:0;
  pointer-events:none;
  animation:summaryPanelOut .2s cubic-bezier(.4,0,.2,1) both;
}
.summary-backdrop{
  position:fixed;
  inset:var(--topbar-h) 0 0;
  background:rgba(15,23,42,.3);
  opacity:0;
  pointer-events:none;
  transition:opacity var(--trans);
  z-index:250;
}
.body-summary-open .summary-backdrop{
  opacity:1;
  pointer-events:auto;
}
.body-summary-closing .summary-backdrop{
  opacity:0;
  pointer-events:none;
}
.sum-panel-head{
  padding:16px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  background:var(--surface2);
  flex-shrink:0;
  position:relative;
}
.sum-panel-head-actions{display:flex;align-items:center;gap:10px;}
.sum-panel-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--txt);}
.sum-compact-toggle{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:700;color:var(--muted);}
.sum-compact-toggle input{accent-color:var(--a);}
.sum-panel-close{
  width:28px;height:28px;border-radius:6px;
  background:none;border:none;cursor:pointer;
  color:var(--muted);font-size:14px;
  display:grid;place-items:center;
  transition:all var(--trans);
}
.sum-panel-close:hover{background:var(--r-l);color:var(--r);}
.sum-panel-body{
  flex:1;overflow-y:auto;padding:14px;
  scrollbar-width:thin;scrollbar-color:var(--border) transparent;
}

/* Summary score ring */
.sum-score{
  display:flex;flex-direction:column;align-items:center;
  padding:18px 0 14px;
}
.score-ring{position:relative;width:90px;height:90px;}
.score-ring svg{transform:rotate(-90deg);}
.score-ring circle{transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1);}
.score-pct{
  position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  font-family:'Syne',sans-serif;
}
.score-pct .pct-num{font-size:20px;font-weight:800;color:var(--txt);}
.score-pct .pct-lbl{font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.score-status-txt{font-size:12px;font-weight:700;margin-top:8px;}

/* Summary tab checklist */
.sum-tab-row{
  display:flex;align-items:center;gap:8px;
  padding:8px 10px;border-radius:8px;
  margin-bottom:4px;cursor:pointer;
  transition:all var(--trans);
}
.sum-tab-row:hover{background:var(--surface2);}
.sum-tab-ico{width:22px;height:22px;border-radius:5px;display:grid;place-items:center;font-size:10px;flex-shrink:0;}
.sum-ico-g{background:var(--g-l);color:var(--g);}
.sum-ico-y{background:var(--y-l);color:var(--y);}
.sum-ico-n{background:var(--surface3);color:var(--muted);}
.sum-tab-name{font-size:12.5px;font-weight:600;flex:1;color:var(--txt2);}
.sum-tab-pct{font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:500;color:var(--muted);}
.sum-tab-meta{font-size:10px;color:var(--muted);margin-top:2px;display:block;}
.compact-hidden{display:none;}

.sum-divider{border:none;border-top:1px solid var(--border);margin:12px 0;}
.sum-section{margin-bottom:10px;}
.sum-accordion-btn{
  width:100%;display:flex;align-items:center;justify-content:space-between;gap:8px;
  border:1px solid var(--border);background:var(--surface2);color:var(--txt2);
  border-radius:8px;padding:8px 10px;cursor:pointer;font-size:10px;font-weight:800;
  letter-spacing:.8px;text-transform:uppercase;transition:all var(--trans);
}
.sum-accordion-btn:hover{border-color:var(--a);color:var(--a);}
.sum-accordion-btn .bi{font-size:12px;transition:transform var(--trans);}
.sum-section.collapsed .sum-accordion-btn .bi{transform:rotate(-90deg);}
.sum-section-body{padding-top:8px;}
.sum-section.collapsed .sum-section-body{display:none;}

/* Summary detail items */
.sum-detail{background:var(--surface2);border-radius:8px;padding:10px 12px;margin-bottom:6px;}
.sum-detail-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);}
.sum-detail-val{font-size:13px;font-weight:700;color:var(--txt);margin-top:3px;}
.sum-detail-val.empty{color:var(--muted);font-weight:400;font-style:italic;font-size:12px;}

/* Alert items */
.sum-alert{display:flex;gap:7px;padding:8px 10px;border-radius:7px;font-size:11.5px;line-height:1.5;margin-bottom:5px;}
.sum-alert.warn{background:var(--color-warning-bg);color:var(--y);}
.sum-alert.ok{background:var(--color-success-bg);color:var(--g);}
.sum-alert i{flex-shrink:0;font-size:13px;margin-top:1px;}
.sum-priority-wrap{display:flex;flex-direction:column;gap:6px;margin-bottom:8px;}
.sum-priority{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;display:flex;flex-direction:column;gap:6px;}
.sum-priority-title{font-size:11px;font-weight:800;color:var(--txt);line-height:1.35;}
.sum-priority-body{font-size:11.5px;color:var(--txt2);line-height:1.45;}
.sum-priority-cta{display:inline-flex;align-items:center;gap:6px;width:max-content;padding:5px 8px;border-radius:999px;border:1px solid var(--a);background:var(--a-l);color:var(--a);font-size:11px;font-weight:700;cursor:pointer;}
.sum-priority-cta:hover{background:#dbeafe;}
.sum-priority-rules{margin-top:7px;padding:7px 10px;border-radius:8px;background:var(--surface2);border:1px dashed var(--border2);}
.sum-priority-rules ul{margin:5px 0 0 16px;padding:0;}
.sum-priority-rules li{font-size:10.8px;color:var(--muted);line-height:1.45;}

.sum-badge{display:inline-block;font-size:10.5px;font-weight:700;padding:2px 8px;border-radius:20px;margin:2px 2px 0 0;}
.sum-badge.blue{background:var(--a-l);color:var(--a);}
.sum-badge.green{background:var(--g-l);color:var(--g);}
.sum-badge.yellow{background:var(--y-l);color:var(--y);}

/* ══════════ PAGE HEADER ══════════ */
.page-header{margin-bottom:24px;animation:fadeUp .3s ease both;}
.page-header h1{
  font-family:'Syne',sans-serif;
  font-size:26px;font-weight:800;color:var(--txt);letter-spacing:-.6px;
  position:relative;display:inline-block;
}
.page-header h1::after{
  content:'';position:absolute;bottom:-4px;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--a),#7c3aed);border-radius:2px;
  transform:scaleX(0);transform-origin:left;
  animation:scaleX .5s .2s ease forwards;
}
@keyframes scaleX{to{transform:scaleX(1)}}
.page-header p{font-size:13px;color:var(--muted);margin-top:10px;line-height:1.6;}

/* Step indicator */
.step-indicator{
  display:flex;align-items:center;gap:4px;
  font-family:'JetBrains Mono',monospace;
  font-size:11px;color:var(--muted);
  margin-bottom:6px;font-weight:500;
}
.step-dot{width:6px;height:6px;border-radius:50%;background:var(--a);}

/* ══════════ CARDS ══════════ */
.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:18px;
  overflow:visible;
  transition:box-shadow var(--trans),transform var(--trans);
  animation:fadeUp .3s ease both;
}
.card:hover{box-shadow:var(--shadow-md);}
.card-nth-1{animation-delay:.05s}
.card-nth-2{animation-delay:.1s}
.card-nth-3{animation-delay:.15s}
.card-nth-4{animation-delay:.2s}

.card-head{
  padding:13px 18px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;
  background:var(--surface2);
}
.card-ico{
  width:30px;height:30px;border-radius:7px;
  display:grid;place-items:center;font-size:13px;flex-shrink:0;
}
.ci-blue{background:var(--a-l);color:var(--a);}
.ci-green{background:var(--g-l);color:var(--g);}
.ci-yellow{background:var(--y-l);color:var(--y);}
.ci-red{background:var(--r-l);color:var(--r);}
.ci-purple{background:#ede9fe;color:#7c3aed;}
.card-title{
  font-family:'Syne',sans-serif;
  font-size:13px;font-weight:700;color:var(--txt);flex:1;
}
.card-badge{font-size:10px;padding:2px 9px;border-radius:20px;font-weight:700;}
.badge-req{background:var(--a-l);color:var(--a);}
.badge-opt{background:var(--g-l);color:var(--g);}
.badge-ux{background:var(--y-l);color:var(--y);}
.card-body{padding:18px;}

/* Collapsible card */
.card-head.collapsible{cursor:pointer;user-select:none;}
.card-head.collapsible:hover{background:var(--surface3);}
.collapse-chevron{color:var(--muted);transition:transform var(--trans);}
.card.collapsed .collapse-chevron{transform:rotate(-90deg);}
.card.collapsed .card-body{display:none;}

/* ══════════ FORM ELEMENTS ══════════ */
.form-row{display:grid;gap:14px;margin-bottom:14px;}
.form-row.cols-2{grid-template-columns:1fr 1fr;}
.form-row.cols-3{grid-template-columns:1fr 1fr 1fr;}
.form-row.cols-4{grid-template-columns:1fr 1fr 1fr 1fr;}
.form-row.auto{grid-template-columns:repeat(auto-fit,minmax(180px,1fr));}

.field{display:flex;flex-direction:column;gap:5px;}
.field-label{
  font-size:10.5px;font-weight:700;letter-spacing:.5px;
  text-transform:uppercase;color:var(--muted);
  display:flex;align-items:center;gap:5px;
}
.req-star{color:var(--r);font-size:12px;}
.tip-btn{
  width:15px;height:15px;border-radius:50%;
  background:var(--surface-elevated);border:1px solid var(--border2);
  color:var(--muted);cursor:help;display:grid;place-items:center;
  font-size:9px;transition:all var(--trans);flex-shrink:0;
  font-style:normal;
}
.tip-btn:hover{background:var(--color-info-bg);border-color:var(--a);color:var(--a);}
/* tooltip popup */
.tip-btn{position:relative;}
.tip-popup{
  position:absolute;top:calc(100% + 8px);left:50%;transform:translateX(-50%);
  background:var(--txt);color:#fff;border-radius:9px;
  padding:9px 13px;font-size:11.5px;line-height:1.55;
  white-space:normal;max-width:min(300px,calc(100vw - 24px));min-width:160px;
  pointer-events:none;z-index:500;
  opacity:0;transform:translateX(-50%) translateY(5px);
  transition:opacity .18s,transform .18s;
  font-weight:500;font-family:'Epilogue',sans-serif;
  text-transform:none;letter-spacing:0;
  box-shadow:0 8px 30px rgba(0,0,0,.25);
}
.tip-popup::after{
  content:'';position:absolute;bottom:100%;left:50%;transform:translateX(-50%);
  border:5px solid transparent;border-bottom-color:var(--txt);
}
.tip-btn:hover .tip-popup,.tip-btn:focus .tip-popup{
  opacity:0;transform:translateX(-50%) translateY(5px);
}

.global-tip{
  position:fixed;
  z-index:1200;
  background:var(--txt);
  color:var(--surface);
  border-radius:9px;
  padding:9px 13px;
  font-size:11.5px;
  line-height:1.55;
  max-width:min(340px,calc(100vw - 20px));
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  pointer-events:none;
  opacity:0;
  transform:translateY(6px);
  transition:opacity .16s,transform .16s;
}
.global-tip.visible{opacity:1;transform:translateY(0);}

@media (prefers-contrast: more), (forced-colors: active){
  .global-tip{
    border:2px solid currentColor;
    background:#000;
    color:#fff;
    box-shadow:none;
    opacity:1;
  }
}

@media(max-width:900px){
  .tip-popup{left:auto;right:0;transform:translateY(5px);}
  .tip-btn:hover .tip-popup,.tip-btn:focus .tip-popup{transform:translateY(0);}
  .tip-popup::after{left:auto;right:8px;transform:none;}
}

@media(max-width:900px){
  .tip-popup{left:auto;right:0;transform:translateY(5px);}
  .tip-btn:hover .tip-popup,.tip-btn:focus .tip-popup{transform:translateY(0);}
  .tip-popup::after{left:auto;right:8px;transform:none;}
}

.fc,.fs{
  background:var(--surface);border:1.5px solid var(--border);
  color:var(--txt);border-radius:var(--radius-sm);
  font-size:13.5px;font-family:'Epilogue',sans-serif;font-weight:500;
  padding:9px 12px;width:100%;
  transition:border-color var(--trans),box-shadow var(--trans),background var(--trans);
}
.fc:focus,.fs:focus{
  border-color:var(--a);box-shadow:0 0 0 3px rgba(37,99,235,.12);
  outline:none;background:#fff;
}
.fc.filled{border-color:var(--g);background:#fafffe;}
.fc.filled:focus{border-color:var(--g);box-shadow:0 0 0 3px rgba(5,150,105,.1);}
.fc::placeholder{color:var(--muted);font-weight:400;}
textarea.fc{resize:vertical;min-height:80px;line-height:1.6;}
.mono{font-family:'JetBrains Mono',monospace;font-size:12.5px;}
.field-hint{font-size:11.5px;color:var(--muted);line-height:1.5;display:flex;align-items:flex-start;gap:5px;}
.field-hint i{color:var(--a);flex-shrink:0;margin-top:1px;}
.fc.validation-error,.fs.validation-error{border-color:#dc2626;background:#fef2f2;}
.fc.validation-error:focus,.fs.validation-error:focus{box-shadow:0 0 0 3px rgba(220,38,38,.14);}
.field-validation-message{display:none;margin-top:6px;font-size:11.5px;color:#b91c1c;line-height:1.45;}
.field-validation-message.visible{display:block;}
.sum-alert-list{margin:0;padding-left:18px;}
.sum-alert-list li{margin-bottom:3px;}

/* ══════════ RADIO PILLS ══════════ */
.radio-group{display:flex;flex-wrap:wrap;gap:6px;}
.rpill input[type=radio]{display:none;}
.rpill label{
  background:var(--surface2);border:1.5px solid var(--border);
  border-radius:20px;padding:5px 14px;
  font-size:12.5px;font-weight:600;color:var(--muted);
  cursor:pointer;transition:all var(--trans);
  font-family:'Epilogue',sans-serif;
}
.rpill input:checked+label{
  background:var(--a);border-color:var(--a);color:#fff;
  box-shadow:0 4px 10px rgba(37,99,235,.25);
  transform:translateY(-1px);
}
.rpill label:hover{border-color:var(--a);color:var(--a);}

/* ══════════ TOGGLE SWITCH ══════════ */
.toggle-row{display:flex;align-items:center;gap:10px;padding:4px 0;}
.toggle-sw{position:relative;width:38px;height:22px;flex-shrink:0;}
.toggle-sw input{opacity:0;width:0;height:0;}
.toggle-track{
  position:absolute;inset:0;border-radius:11px;
  background:var(--border2);cursor:pointer;transition:all var(--trans);
}
.toggle-sw input:checked~.toggle-track{background:var(--a);}
.toggle-thumb{
  position:absolute;top:3px;left:3px;
  width:16px;height:16px;border-radius:50%;
  background:#fff;transition:transform var(--bounce);
  box-shadow:0 1px 4px rgba(0,0,0,.2);pointer-events:none;
}
.toggle-sw input:checked~.toggle-track .toggle-thumb{transform:translateX(16px);}
.toggle-label{font-size:13px;font-weight:600;color:var(--txt2);cursor:pointer;line-height:1.3;}

/* ══════════ DYNAMIC TABLE ══════════ */
.dt-wrap{overflow-x:auto;border-radius:var(--radius-sm);border:1px solid var(--border);}
.dt{width:100%;border-collapse:collapse;min-width:500px;}
.dt thead th{
  background:var(--surface2);
  font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;
  color:var(--label,var(--muted));padding:9px 10px;border-bottom:1px solid var(--border);
  white-space:nowrap;
}
.dt tbody tr{border-bottom:1px solid var(--border);transition:background var(--trans);}
.dt tbody tr:last-child{border-bottom:none;}
.dt tbody tr:hover{background:var(--a-l);}
.dt td{padding:6px 8px;vertical-align:middle;}
.dt input,.dt select,.dt textarea{
  background:var(--surface);border:1.5px solid var(--border);
  color:var(--txt);border-radius:6px;padding:5px 8px;
  font-size:12.5px;font-family:'Epilogue',sans-serif;font-weight:500;width:100%;
  transition:border var(--trans);
}
.dt input:focus,.dt select:focus{outline:none;border-color:var(--a);}
.row-num{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);text-align:center;}
.drag-handle{color:var(--border2);cursor:grab;font-size:14px;display:block;text-align:center;}
.row-move{display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;}
.row-actions{display:flex;align-items:center;justify-content:center;gap:6px;}
.btn-move{
  width:22px;height:22px;border-radius:6px;
  border:1px solid var(--border);
  background:var(--surface2);color:var(--muted);
  display:grid;place-items:center;
  cursor:pointer;font-size:11px;
  transition:all var(--trans);
}
.btn-move:hover{border-color:var(--a);color:var(--a);background:var(--a-l);}

/* ══════════ BUTTONS ══════════ */
.btn-add{
  display:inline-flex;align-items:center;gap:6px;
  padding:7px 14px;border:1.5px dashed var(--border2);
  border-radius:var(--radius-sm);font-size:12.5px;font-weight:700;
  color:var(--a);background:transparent;cursor:pointer;
  transition:all var(--trans);font-family:'Epilogue',sans-serif;
}
.btn-add:hover{border-color:var(--a);background:var(--a-l);transform:translateY(-1px);}
.btn-rm{
  background:none;border:none;color:var(--muted);cursor:pointer;
  padding:4px;border-radius:5px;transition:all var(--trans);font-size:14px;
}
.btn-rm:hover{color:var(--r);background:var(--r-l);}
.btn-primary{
  background:linear-gradient(135deg,var(--a),var(--a-d));
  color:#fff;border:none;border-radius:var(--radius-sm);
  padding:10px 22px;font-size:14px;font-weight:700;
  cursor:pointer;transition:all var(--trans);
  display:inline-flex;align-items:center;gap:7px;
  font-family:'Epilogue',sans-serif;
  box-shadow:0 4px 14px rgba(37,99,235,.3);
}
.btn-primary:hover{box-shadow:0 6px 20px rgba(37,99,235,.4);transform:translateY(-2px);}
.btn-secondary{
  background:var(--surface);color:var(--txt2);border:1.5px solid var(--border);
  border-radius:var(--radius-sm);padding:10px 18px;font-size:14px;font-weight:700;
  cursor:pointer;transition:all var(--trans);
  display:inline-flex;align-items:center;gap:7px;
  font-family:'Epilogue',sans-serif;
}
.btn-secondary:hover{border-color:var(--a);color:var(--a);transform:translateY(-1px);}
.btn-danger-sm{
  background:var(--r-l);color:var(--r);border:1px solid rgba(220,38,38,.2);
  border-radius:6px;padding:4px 10px;font-size:12px;font-weight:700;cursor:pointer;
  transition:all var(--trans);font-family:'Epilogue',sans-serif;
}
.btn-danger-sm:hover{background:#fca5a5;transform:scale(1.02);}

/* Nav arrows */
.nav-actions{display:flex;justify-content:space-between;align-items:center;margin-top:24px;padding-top:20px;border-top:1px solid var(--border);}

/* ══════════ INFO ALERTS ══════════ */
.info-alert,.warn-alert{
  border-radius:var(--radius-sm);padding:11px 14px;
  font-size:12.5px;color:var(--txt2);
  display:flex;gap:9px;line-height:1.55;margin-bottom:14px;
}
.info-alert{background:var(--a-l);border:1px solid rgba(37,99,235,.15);}
.warn-alert{background:var(--y-l);border:1px solid rgba(217,119,6,.2);color:#78350f;}
.info-alert i,.warn-alert i{flex-shrink:0;font-size:15px;margin-top:1px;}
.info-alert i{color:var(--a);}
.warn-alert i{color:var(--y);}

/* ══════════ HF ZONES ══════════ */
.hf-zone{border:1.5px solid var(--border);border-radius:var(--radius);margin-bottom:14px;overflow:visible;transition:all var(--trans);}
.hf-zone:hover{border-color:var(--border2);box-shadow:var(--shadow);}
.hf-zone-head{padding:12px 16px;display:flex;align-items:center;gap:9px;font-size:12px;font-weight:800;cursor:pointer;}
.hf-rh{background:linear-gradient(135deg,#d1fae5,#a7f3d0)!important;color:#065f46;}
.hf-ph{background:linear-gradient(135deg,#dbeafe,#bfdbfe)!important;color:#1e3a8a;}
.hf-pf{background:linear-gradient(135deg,#fef3c7,#fde68a)!important;color:#78350f;}
.hf-rf{background:linear-gradient(135deg,#fee2e2,#fecaca)!important;color:#7f1d1d;}
.hf-body{padding:16px;border-top:1px solid var(--border);}
.hf-zone.hf-collapsed .hf-body{display:none;}
.hf-chevron{margin-left:auto;font-size:12px;transition:transform var(--trans);}
.hf-zone.hf-collapsed .hf-chevron{transform:rotate(-90deg);}

/* ══════════ SUBREPORT CARDS ══════════ */
.sr-card{border:1.5px solid var(--border);border-radius:var(--radius);margin-bottom:12px;overflow:visible;transition:all var(--trans);}
.sr-card:hover{border-color:var(--border2);box-shadow:var(--shadow);}
.sr-head{padding:11px 16px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.sr-pill{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;}
.sr-inline{background:var(--a-l);color:var(--a);}
.sr-ondemand{background:var(--g-l);color:var(--g);}
.sr-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--surface2);overflow-x:auto;}
.sr-tab{
  padding:9px 14px;font-size:12px;font-weight:700;color:var(--muted);
  border:none;background:none;cursor:pointer;
  border-bottom:2px solid transparent;margin-bottom:-1px;
  transition:all var(--trans);white-space:nowrap;
  font-family:'Epilogue',sans-serif;
}
.sr-tab.active{color:var(--a);border-bottom-color:var(--a);}
.sr-pane{display:none;padding:16px;}
.sr-pane.active{display:block;animation:tabPaneFade .25s ease;}

/* ══════════ CONDITION BUILDER ══════════ */
.cond-group{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);margin-bottom:10px;overflow:visible;transition:all var(--trans);}
.cond-group-bar{background:var(--surface2);padding:9px 14px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.logic-sel{background:var(--surface);border:1.5px solid var(--border);color:var(--a);border-radius:6px;padding:3px 8px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Epilogue',sans-serif;}

/* ══════════ EMPTY STATE ══════════ */
.es-preview{background:var(--surface2);border:1.5px dashed var(--border2);border-radius:var(--radius);padding:28px;text-align:center;transition:all var(--trans);}
.es-icon{font-size:40px;color:var(--muted);margin-bottom:10px;display:block;animation:dotPulse 3s ease-in-out infinite;}
.es-title{font-size:15px;font-weight:700;color:var(--txt2);margin-bottom:5px;font-family:'Syne',sans-serif;}
.es-sub{font-size:13px;color:var(--muted);}

/* ══════════ FORMAT CARDS ══════════ */
.fmt-card{border:1.5px solid var(--border);border-radius:var(--radius-sm);margin-bottom:10px;overflow:visible;transition:all var(--trans);}
.fmt-card:hover{border-color:var(--border2);}
.fmt-card:has(.fmt-cb:checked){border-color:var(--a);box-shadow:0 0 0 3px rgba(37,99,235,.08);}
.fmt-head{padding:12px 16px;display:flex;align-items:center;gap:10px;background:var(--surface2);cursor:pointer;transition:all var(--trans);}
.fmt-head:hover{background:var(--surface3);}
.fmt-ico{width:30px;height:30px;border-radius:7px;display:grid;place-items:center;font-size:14px;flex-shrink:0;}
.fmt-pdf{background:var(--r-l);color:var(--r);}
.fmt-xls{background:var(--g-l);color:var(--g);}
.fmt-doc{background:var(--a-l);color:var(--a);}
.fmt-csv{background:var(--y-l);color:var(--y);}
.fmt-name{font-size:13px;font-weight:700;flex:1;color:var(--txt);font-family:'Syne',sans-serif;}
.fmt-chevron{color:var(--muted);font-size:12px;transition:transform var(--trans);}
.fmt-body{display:none;padding:16px;border-top:1px solid var(--border);}
.fmt-body.open{display:block;animation:tabPaneFade .25s ease;}

/* ══════════ TOKEN CHIPS ══════════ */
.token-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
.tchip{
  font-size:11px;font-family:'JetBrains Mono',monospace;
  background:var(--a-l);border:1px solid rgba(37,99,235,.2);
  color:var(--a);border-radius:5px;padding:3px 9px;
  cursor:pointer;transition:all var(--trans);
}
.tchip:hover{background:var(--a);color:#fff;transform:translateY(-1px);}
.tchip.g{background:var(--g-l);border-color:rgba(5,150,105,.2);color:var(--g);}
.tchip.g:hover{background:var(--g);color:#fff;}
.tchip.y{background:var(--y-l);border-color:rgba(217,119,6,.2);color:var(--y);}
.tchip.y:hover{background:var(--y);color:#fff;}

/* ══════════ FOOTER BAR ══════════ */
.footer-bar{
  position:fixed;bottom:0;
  left:var(--sidebar-w);right:0;
  background:rgba(255,255,255,.92);
  backdrop-filter:blur(12px);
  border-top:1px solid var(--border);
  padding:10px 28px;
  display:flex;justify-content:space-between;align-items:center;
  z-index:130;
  transition:left var(--trans),right var(--trans);
  box-shadow:0 -4px 20px rgba(15,23,42,.06);
}
.body-sidebar-collapsed .footer-bar{left:var(--sidebar-collapsed);}
.footer-info{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);display:flex;align-items:center;gap:10px;}
.footer-step{background:var(--a-l);color:var(--a);padding:2px 8px;border-radius:20px;font-weight:700;}
.footer-actions{display:flex;gap:8px;}

/* ══════════ TOAST ══════════ */
.toast-container{position:fixed;bottom:80px;right:20px;z-index:999;display:flex;flex-direction:column;gap:8px;}
.toast{
  background:var(--surface-overlay);color:#fff;border-radius:10px;
  padding:11px 16px;font-size:13px;font-weight:600;
  display:flex;align-items:center;gap:9px;
  box-shadow:var(--shadow-lg);min-width:220px;
  animation:toastIn .3s var(--bounce) both;
  font-family:'Epilogue',sans-serif;
}
.toast.success{background:var(--color-success-bg);color:var(--g);}
.toast.warning{background:var(--color-warning-bg);color:var(--y);}
.toast.removing{animation:toastOut .25s ease forwards;}

/* ══════════ MOBILE OVERLAY ══════════ */
.mobile-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(15,23,42,.5);z-index:145;
  backdrop-filter:blur(4px);
}
.mobile-menu-btn{
  display:none;width:36px;height:36px;border-radius:var(--radius-sm);
  background:none;border:1.5px solid var(--border);
  color:var(--txt);cursor:pointer;place-items:center;font-size:16px;
  margin-right:4px;flex-shrink:0;
}

/* ══════════ RESPONSIVE ══════════ */
@media(max-width:900px){
  :root{--sidebar-w:260px;}
  .sidebar{transform:translateX(-100%);width:var(--sidebar-w)!important;}
  .sidebar.mobile-open{transform:translateX(0);}
  .main{margin-left:0!important;}
  .footer-bar{left:0!important;}
  .topbar-brand{min-width:auto;}
  .mobile-menu-btn{display:grid;}
  .mobile-overlay.open{display:block;}
  .global-progress{max-width:200px;}
  .topbar-center .progress-label{display:none;}
  .tab-content{padding:20px 16px 100px;}
  .form-row.cols-3,.form-row.cols-4{grid-template-columns:1fr 1fr;}
  .form-row.cols-2{grid-template-columns:1fr;}
  .summary-panel{
    top:auto;
    inset:0;
    width:100vw;
    max-width:none;
    border-left:none;
    border-top:1px solid var(--border);
    border-radius:16px 16px 0 0;
    box-shadow:0 -12px 40px rgba(15,23,42,.26);
    transform:translateY(100%);
  }
  .body-summary-open .summary-panel,
  .body-summary-closing .summary-panel{z-index:300;}
  .body-summary-open .summary-panel{transform:translateY(0);}
  .body-summary-closing .summary-panel{transform:translateY(100%);}
  .sum-panel-head{
    padding:16px;
    gap:8px;
  }
  .sum-panel-head::before{
    content:'';
    position:absolute;
    top:8px;
    left:50%;
    transform:translateX(-50%);
    width:42px;
    height:4px;
    border-radius:999px;
    background:var(--border2);
  }
  .sum-panel-title{font-size:15px;}
  .quick-actions{padding:0 16px;}
  .tab-content{padding-top:12px;}
}
@media(max-width:600px){
  .form-row.cols-2,.form-row.cols-3,.form-row.cols-4{grid-template-columns:1fr;}
  .page-header h1{font-size:20px;}
  .tb-btn span{display:none;}
  .topbar-right .tb-btn:not(.primary){display:none;}
  .dt{min-width:400px;}
}

/* ══════════ SCROLLBAR ══════════ */
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}

/* ══════════ CHECKBOX ══════════ */
input[type=checkbox]{accent-color:var(--a);width:15px;height:15px;cursor:pointer;}
input[type=color]{border-radius:6px;border:1.5px solid var(--border);cursor:pointer;height:34px;}
select.fs option{background:#fff;}
body.theme-dark .topbar,
body.theme-dark .footer-bar{background:rgba(17,24,39,.9);}
body.theme-dark .global-tip{background:var(--surface-overlay);color:#e2e8f0;}
</style>
</head>
<body>

<!-- ═══════════════ TOPBAR ═══════════════ -->
<nav class="topbar" id="topbar">
  <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="openMobileMenu()"><i class="bi bi-list"></i></button>
  <a class="topbar-brand" href="#">
    <div class="brand-logo"><i class="bi bi-file-earmark-bar-graph"></i></div>
    <span class="brand-text">Report<span>Forge</span></span>
  </a>
  <div class="topbar-center">
    <button class="sidebar-toggle" onclick="toggleSidebar()" title="Pokaż/ukryj nawigację">
      <i class="bi bi-layout-sidebar"></i>
    </button>
    <div class="global-progress" title="Postęp wypełnienia formularza">
      <div class="global-progress-fill" id="globalProgressFill" style="width:0%"></div>
    </div>
    <span class="progress-label" id="progressLabel">0% gotowe</span>
  </div>
  <div class="topbar-right">
    <div class="theme-switch" role="group" aria-label="Tryb kolorystyczny">
      <button class="theme-switch-btn active" id="themeLightBtn" type="button" onclick="setTheme('light')"><i class="bi bi-sun-fill"></i><span>LIGHT</span></button>
      <button class="theme-switch-btn" id="themeDarkBtn" type="button" onclick="setTheme('dark')"><i class="bi bi-moon-stars-fill"></i><span>DARK MODE</span></button>
      <button class="theme-switch-btn" id="themeAutoBtn" type="button" onclick="setTheme('auto')"><i class="bi bi-circle-half"></i><span>AUTO PLUS</span></button>
    </div>
    <button class="tb-btn" onclick="startNewForm()"><i class="bi bi-plus-square"></i><span>Nowy</span></button>
    <button class="tb-btn" onclick="saveFormToJson()"><i class="bi bi-download"></i><span>Zapisz JSON</span></button>
    <button class="tb-btn" onclick="triggerJsonLoad()"><i class="bi bi-upload"></i><span>Wczytaj JSON</span></button>
    <button class="tb-btn summary-toggle-btn" id="summaryToggleBtn" data-summary-toggle onclick="toggleSummary()"><i class="bi bi-panel-split"></i><span>Podsumowanie</span></button>
    <button class="tb-btn primary" data-summary-toggle onclick="toggleSummary()"><i class="bi bi-file-earmark-text"></i><span>Generuj dok.</span></button>
  </div>
</nav>
<input type="file" id="jsonImportInput" accept="application/json,.json" style="display:none" onchange="loadFormFromJsonFile(event)"/>

<!-- ═══════════════ MOBILE OVERLAY ═══════════════ -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

<!-- ═══════════════ SHELL ═══════════════ -->
<div class="shell">

  <!-- ═══ SIDEBAR ═══ -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-inner" id="sidebarInner">
      <div class="sidebar-section-label">Definicja raportu</div>

      <button class="tab-btn active" data-tab="t1" onclick="switchTab('t1',this)">
        <div class="tab-ico"><i class="bi bi-info-circle"></i></div>
        <span class="tab-label">Informacje ogólne</span>
        <span class="tab-status none" id="ts-t1"></span>
      </button>
      <button class="tab-btn" data-tab="t2" onclick="switchTab('t2',this)">
        <div class="tab-ico"><i class="bi bi-database"></i></div>
        <span class="tab-label">Źródło SQL</span>
        <span class="tab-status none" id="ts-t2"></span>
      </button>
      <button class="tab-btn" data-tab="t3" onclick="switchTab('t3',this)">
        <div class="tab-ico"><i class="bi bi-table"></i></div>
        <span class="tab-label">Kolumny</span>
        <span class="tab-status none" id="ts-t3"></span>
      </button>
      <button class="tab-btn" data-tab="t4" onclick="switchTab('t4',this)">
        <div class="tab-ico"><i class="bi bi-sliders"></i></div>
        <span class="tab-label">Parametry</span>
        <span class="tab-status none" id="ts-t4"></span>
      </button>
      <button class="tab-btn" data-tab="t5" onclick="switchTab('t5',this)">
        <div class="tab-ico"><i class="bi bi-funnel"></i></div>
        <span class="tab-label">Filtry</span>
        <span class="tab-status none" id="ts-t5"></span>
      </button>
      <button class="tab-btn" data-tab="t6" onclick="switchTab('t6',this)">
        <div class="tab-ico"><i class="bi bi-collection"></i></div>
        <span class="tab-label">Grupowanie</span>
        <span class="tab-status none" id="ts-t6"></span>
      </button>
      <button class="tab-btn" data-tab="t7" onclick="switchTab('t7',this)">
        <div class="tab-ico"><i class="bi bi-diagram-2"></i></div>
        <span class="tab-label">Podraporty</span>
        <span class="tab-status none" id="ts-t7"></span>
      </button>

      <div class="sidebar-section-label" style="margin-top:8px">Prezentacja</div>

      <button class="tab-btn" data-tab="t8" onclick="switchTab('t8',this)">
        <div class="tab-ico"><i class="bi bi-layout-text-window"></i></div>
        <span class="tab-label">Nagłówki / Stopki</span>
        <span class="tab-status none" id="ts-t8"></span>
      </button>
      <button class="tab-btn" data-tab="t9" onclick="switchTab('t9',this)">
        <div class="tab-ico"><i class="bi bi-inbox"></i></div>
        <span class="tab-label">Brak danych</span>
        <span class="tab-status none" id="ts-t9"></span>
      </button>
      <button class="tab-btn" data-tab="t10" onclick="switchTab('t10',this)">
        <div class="tab-ico"><i class="bi bi-box-arrow-up-right"></i></div>
        <span class="tab-label">Opcje wyjścia</span>
        <span class="tab-status none" id="ts-t10"></span>
      </button>
    </div>

    <div class="sidebar-footer">
      <button class="sidebar-footer-btn" onclick="showToast('Szkic zapisany!','success')">
        <i class="bi bi-save"></i><span class="tab-label">Zapisz szkic</span>
      </button>
      <button class="sidebar-footer-btn" data-summary-toggle onclick="toggleSummary()">
        <i class="bi bi-eye"></i><span class="tab-label">Podgląd podsumowania</span>
      </button>
    </div>
  </nav>

  <!-- ═══ MAIN ═══ -->
  <main class="main">
    <form id="reportDefinitionForm">
      <div class="quick-actions" aria-label="Szybkie akcje formularza">
        <button class="quick-action-chip lightning" type="button" onclick="clearCurrentSection()"><i class="bi bi-lightning-charge"></i>Wyczyść sekcję</button>
        <button class="quick-action-chip warning" type="button" onclick="jumpToErrors()"><i class="bi bi-exclamation-circle"></i>Przejdź do błędów</button>
        <button class="quick-action-chip success" type="button" onclick="copySummaryToClipboard()"><i class="bi bi-clipboard-check"></i>Skopiuj podsumowanie</button>
      </div>
      <div class="tab-content">

      <!-- ══ TAB 1 ══ -->
      <div class="tab-pane active" id="t1">
        <div class="step-indicator"><div class="step-dot"></div>Krok 1 z 10</div>
        <div class="page-header">
          <h1>Informacje ogólne</h1>
          <p>Podstawowe metadane identyfikujące raport w systemie, dokumentacji technicznej i backlogu dewelopera.</p>
        </div>

        <div class="card card-nth-1">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-blue"><i class="bi bi-tag"></i></div>
            <span class="card-title">Identyfikacja raportu</span>
            <span class="card-badge badge-req">WYMAGANE</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-2">
              <div class="field">
                <label class="field-label">Nazwa raportu <span class="req-star">*</span>
                  <i class="tip-btn">?<span class="tip-popup">Unikalna techniczna nazwa w systemie. Używana jako identyfikator w C# przy ładowaniu .rpt. Bez spacji — użyj camelCase lub podkreśleń.</span></i>
                </label>
                <input type="text" class="fc" id="rName" placeholder="np. RaportSprzedazyMiesiecznej" required minlength="3" pattern="[A-Za-z0-9_]+" title="Użyj tylko liter, cyfr i podkreśleń (bez spacji)." oninput="onFieldChange(this)"/>
                <div class="field-hint"><i class="bi bi-info-circle"></i>Nazwa pliku .rpt i identyfikator w kodzie</div>
              </div>
              <div class="field">
                <label class="field-label">Tytuł wyświetlany <span class="req-star">*</span>
                  <i class="tip-btn">?<span class="tip-popup">Tekst widoczny dla użytkownika na wydruku. Może zawierać tokeny CR np. {?Miesiąc} zastępowane dynamicznie.</span></i>
                </label>
                <input type="text" class="fc" id="rTitle" placeholder="np. RAPORT SPRZEDAŻY — {?Miesiąc} {?Rok}" required minlength="5" oninput="onFieldChange(this)"/>
              </div>
            </div>
            <div class="form-row cols-3">
              <div class="field">
                <label class="field-label">Wersja <i class="tip-btn">?<span class="tip-popup">Semantyczna wersja raportu (SemVer: MAJOR.MINOR.PATCH). Pozwala śledzić historię zmian i robić rollback.</span></i></label>
                <input type="text" class="fc" id="rVersion" placeholder="1.0.0" oninput="onFieldChange(this)"/>
              </div>
              <div class="field">
                <label class="field-label">Status</label>
                <select class="fs" id="rStatus" onchange="onFieldChange(this)">
                  <option>Szkic</option><option>Do weryfikacji</option>
                  <option>Zatwierdzone</option><option>W realizacji</option>
                  <option>Zarchiwizowane</option>
                </select>
              </div>
              <div class="field">
                <label class="field-label">Priorytet <i class="tip-btn">?<span class="tip-popup">Wpływa na kolejność w backlogu. Krytyczny = blokuje inne procesy i wymaga natychmiastowej realizacji.</span></i></label>
                <select class="fs" id="rPriority" onchange="onFieldChange(this)">
                  <option>— wybierz —</option><option>Krytyczny 🔴</option>
                  <option>Wysoki 🟠</option><option>Normalny 🟡</option><option>Niski 🟢</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="field">
                <label class="field-label">Opis / cel raportu <span class="req-star">*</span>
                  <i class="tip-btn">?<span class="tip-popup">Opisz: dla kogo jest raport, jakie decyzje biznesowe wspiera, jakie dane prezentuje i jak często jest generowany. Trafi do dokumentacji technicznej.</span></i>
                </label>
                <textarea class="fc" id="rDesc" placeholder="Opisz przeznaczenie raportu, grupę docelową użytkowników, jakie decyzje biznesowe wspiera oraz jak często będzie generowany..." required minlength="20" oninput="onFieldChange(this)"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-nth-2">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-purple"><i class="bi bi-people"></i></div>
            <span class="card-title">Odpowiedzialność i terminy</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-3">
              <div class="field"><label class="field-label">Autor <i class="tip-btn">?<span class="tip-popup">Osoba wypełniająca formularz — punkt kontaktu przy pytaniach do specyfikacji.</span></i></label><input type="text" class="fc" placeholder="Imię i nazwisko" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Właściciel biznesowy <i class="tip-btn">?<span class="tip-popup">Dział/osoba zamawiająca. Odpowiedzialna za akceptację wymagań i odbiór końcowy raportu.</span></i></label><input type="text" class="fc" placeholder="Dział / email" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Nr ticketu <i class="tip-btn">?<span class="tip-popup">Numer zadania w JIRA/Azure DevOps. Umożliwia powiązanie dokumentacji z kodem i śledzenie zmian.</span></i></label><input type="text" class="fc" placeholder="np. PROJ-1234" oninput="onFieldChange(this)"/></div>
            </div>
            <div class="form-row cols-2">
              <div class="field"><label class="field-label">Data zlecenia</label><input type="date" class="fc" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Termin realizacji</label><input type="date" class="fc" oninput="onFieldChange(this)"/></div>
            </div>
            <div class="field"><label class="field-label">Uwagi i ograniczenia <i class="tip-btn">?<span class="tip-popup">Wszystko czego nie obejmują pozostałe pola: ograniczenia wydajnościowe, zależności, znane wyjątki danych, wymagania bezpieczeństwa.</span></i></label><textarea class="fc" placeholder="np. Raport max 1×/dzień ze względu na wydajność. Dane wrażliwe — dostęp tylko dla roli MANAGER..." oninput="onFieldChange(this)"></textarea></div>
          </div>
        </div>

        <div class="nav-actions">
          <div></div>
          <button class="btn-primary" onclick="goTab('t2')">Dalej: Źródło SQL <i class="bi bi-arrow-right"></i></button>
        </div>
      </div>

      <!-- ══ TAB 2 ══ -->
      <div class="tab-pane" id="t2">
        <div class="step-indicator"><div class="step-dot"></div>Krok 2 z 10</div>
        <div class="page-header"><h1>Źródło danych (SQL)</h1><p>Zdefiniuj skąd Crystal Reports pobiera dane — widok, procedura składowana lub zapytanie inline.</p></div>

        <div class="card card-nth-1">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-blue"><i class="bi bi-database"></i></div>
            <span class="card-title">Konfiguracja połączenia</span>
            <span class="card-badge badge-req">WYMAGANE</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-3">
              <div class="field">
                <label class="field-label">Typ źródła SQL <span class="req-star">*</span>
                  <i class="tip-btn">?<span class="tip-popup">VIEW = ukrywa SQL przed CR (zalecane). SP = parametryzacja po stronie bazy. Command Object = inline SQL bezpośrednio w CR.</span></i>
                </label>
                <select class="fs" id="sqlType" required onchange="toggleSqlFields();onFieldChange(this)">
                  <option value="">— wybierz typ —</option>
                  <option value="view">Widok (VIEW)</option>
                  <option value="proc">Procedura składowana (SP)</option>
                  <option value="fn">Funkcja tabelaryczna (TVF)</option>
                  <option value="query">Zapytanie SQL inline</option>
                </select>
              </div>
              <div class="field"><label class="field-label">Baza danych / Connection ID <span class="req-star">*</span><i class="tip-btn">?<span class="tip-popup">Nazwa bazy lub klucz Connection String z appsettings.json. Programista użyje tej nazwy w kodzie C#.</span></i></label><input type="text" class="fc" placeholder="np. DB_PRODUKCJA" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Schema <i class="tip-btn">?<span class="tip-popup">Schema bazodanowa — domyślnie 'dbo' w SQL Server. Ważne gdy baza ma wiele schematów: dbo, reporting, hr.</span></i></label><input type="text" class="fc" placeholder="dbo" oninput="onFieldChange(this)"/></div>
            </div>
            <div class="field" id="sqlObjField" style="display:none;margin-bottom:14px">
              <label class="field-label">Nazwa obiektu (VIEW / SP / Funkcja) <i class="tip-btn">?<span class="tip-popup">Pełna kwalifikowana nazwa: schema.nazwa np. dbo.v_Sprzedaz. Programista wpisze to w CR Database Expert.</span></i></label>
              <input type="text" class="fc mono" placeholder="np. dbo.v_RaportSprzedazy" oninput="onFieldChange(this)"/>
            </div>
            <div class="field" id="sqlInlineField" style="display:none;margin-bottom:14px">
              <label class="field-label">Zapytanie SQL <i class="tip-btn">?<span class="tip-popup">Wpisane bezpośrednio w CR Command Object. Użyj {?PARAMETR} dla parametrów CR. Elastyczne ale trudniejsze w utrzymaniu.</span></i></label>
              <textarea class="fc mono" rows="5" placeholder="SELECT&#10;  kol1, kol2, kol3&#10;FROM dbo.Tabela t&#10;  INNER JOIN dbo.Inna i ON t.id = i.fk&#10;WHERE t.data >= {?DataOd}" oninput="onFieldChange(this)"></textarea>
              <div class="field-hint"><i class="bi bi-info-circle"></i>Placeholdery {?NazwaParametru} zastępowane przez CR w runtime.</div>
            </div>
            <div class="field">
              <label class="field-label">Opis logiki biznesowej <i class="tip-btn">?<span class="tip-popup">Opisz co zwraca to źródło w języku biznesowym. Nie technicznie. Trafi do dokumentacji.</span></i></label>
              <textarea class="fc" placeholder="np. Widok łączy tabele Zamówienia, Klienci i Produkty. Zwraca faktury sprzedaży z danego okresu z rozbijem na kategorie..." oninput="onFieldChange(this)"></textarea>
            </div>
          </div>
        </div>

        <div class="card card-nth-2">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-blue"><i class="bi bi-toggles"></i></div>
            <span class="card-title">Dodatkowe opcje</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-3">
              <div class="toggle-row"><label class="toggle-sw"><input type="checkbox" id="swCR"><div class="toggle-track"><div class="toggle-thumb"></div></div></label><span class="toggle-label">Command mode (CR Command Object) <i class="tip-btn" style="vertical-align:middle">?<span class="tip-popup">SQL bezpośrednio w CR bez widoku w bazie. Wygodne jednorazowo, trudniejsze długoterminowo.</span></i></span></div>
              <div class="toggle-row"><label class="toggle-sw"><input type="checkbox" id="swLinked"><div class="toggle-track"><div class="toggle-thumb"></div></div></label><span class="toggle-label">Wiele tabel z linkowaniem <i class="tip-btn" style="vertical-align:middle">?<span class="tip-popup">CR łączy tabele przez Database Expert → Links. Mniej wydajne niż JOIN w SQL.</span></i></span></div>
              <div class="toggle-row"><label class="toggle-sw"><input type="checkbox" id="swLimit"><div class="toggle-track"><div class="toggle-thumb"></div></div></label><span class="toggle-label">Ogranicz liczbę wierszy <i class="tip-btn" style="vertical-align:middle">?<span class="tip-popup">CR Max Rows to Retrieve. Wartość 0 = brak limitu. To nie SQL TOP — CR pobiera wszystko i przycina po stronie klienta.</span></i></span></div>
            </div>
          </div>
        </div>

        <div class="card card-nth-3">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-blue"><i class="bi bi-person-badge"></i></div>
            <span class="card-title">Runtime: logowanie DB</span>
            <span class="card-badge badge-req">WYMAGANE</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-2">
              <div class="field"><label class="field-label">Serwer SQL <span class="req-star">*</span></label><input type="text" class="fc mono" placeholder="np. sql-prod-01\INSTANCE" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Baza danych <span class="req-star">*</span></label><input type="text" class="fc" placeholder="np. ReportingDb" oninput="onFieldChange(this)"/></div>
            </div>
            <div class="form-row cols-2">
              <div class="field"><label class="field-label">Tryb autoryzacji <span class="req-star">*</span></label><select class="fs" onchange="onFieldChange(this)"><option value="">— wybierz —</option><option>Windows Integrated</option><option>SQL Login</option><option>Azure AD / Managed Identity</option></select></div>
              <div class="field"><label class="field-label">Środowisko runtime <span class="req-star">*</span></label><select class="fs" onchange="onFieldChange(this)"><option value="">— wybierz —</option><option>DEV</option><option>TEST</option><option>UAT</option><option>PROD</option></select></div>
            </div>
            <div class="field-hint"><i class="bi bi-info-circle"></i>Jak użyć w C# runtime: uzupełnij <code style="font-family:'JetBrains Mono',monospace">ConnectionInfo</code>, następnie przypisz do tabel przez <code style="font-family:'JetBrains Mono',monospace">ApplyLogOnInfo()</code>.</div>
          </div>
        </div>

        <div class="card card-nth-4">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-blue"><i class="bi bi-diagram-3"></i></div>
            <span class="card-title">Mapowanie tabel po SetDataSource / ApplyLogOnInfo</span>
            <span class="card-badge badge-req">WYMAGANE</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-2">
              <div class="field"><label class="field-label">Mapowanie tabel raportu głównego <span class="req-star">*</span></label><textarea class="fc mono" rows="3" placeholder="np. dbo.v_RaportSprzedazy -> ds.Tables[\"Main\"]" oninput="onFieldChange(this)"></textarea></div>
              <div class="field"><label class="field-label">Mapowanie tabel podraportów <span class="req-star">*</span></label><textarea class="fc mono" rows="3" placeholder="np. SR_Pozycje: dbo.v_Pozycje -> ds.Tables[\"Items\"]" oninput="onFieldChange(this)"></textarea></div>
            </div>
            <div class="field"><label class="field-label">Strategia iteracji tabel <span class="req-star">*</span></label><select class="fs" onchange="onFieldChange(this)"><option value="">— wybierz —</option><option>Najpierw report.Database.Tables, potem subreporty</option><option>Wyłącznie SetDataSource(DataSet)</option><option>Hybrydowo: ApplyLogOnInfo + SetDataSource</option></select></div>
            <div class="field-hint"><i class="bi bi-info-circle"></i>Jak użyć w C# runtime: iteruj po <code style="font-family:'JetBrains Mono',monospace">report.Database.Tables</code> i <code style="font-family:'JetBrains Mono',monospace">report.Subreports</code>, dla każdej tabeli zastosuj ten sam login i mapowanie datasetu.</div>
          </div>
        </div>

        <div class="card card-nth-5">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-yellow"><i class="bi bi-stopwatch"></i></div>
            <span class="card-title">Timeouty i limity</span>
            <span class="card-badge badge-req">WYMAGANE</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-3">
              <div class="field"><label class="field-label">Maks. liczba rekordów <span class="req-star">*</span></label><input type="number" class="fc" min="0" placeholder="np. 200000" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Timeout zapytania SQL (s) <span class="req-star">*</span></label><input type="number" class="fc" min="1" placeholder="np. 120" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Timeout renderowania CR (s) <span class="req-star">*</span></label><input type="number" class="fc" min="1" placeholder="np. 180" oninput="onFieldChange(this)"/></div>
            </div>
            <div class="field"><label class="field-label">Zachowanie po przekroczeniu limitu <span class="req-star">*</span></label><select class="fs" onchange="onFieldChange(this)"><option value="">— wybierz —</option><option>Przerwij i zwróć błąd użytkownikowi</option><option>Przytnij wynik i pokaż ostrzeżenie</option><option>Przełącz na tryb asynchroniczny (kolejka)</option></select></div>
            <div class="field-hint"><i class="bi bi-info-circle"></i>Jak użyć w C# runtime: ustaw timeout na <code style="font-family:'JetBrains Mono',monospace">SqlCommand.CommandTimeout</code> i egzekwuj limity przed <code style="font-family:'JetBrains Mono',monospace">ExportToStream()</code>.</div>
          </div>
        </div>

        <div class="card card-nth-6">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-red"><i class="bi bi-shield-lock"></i></div>
            <span class="card-title">Polityka bezpieczeństwa danych</span>
            <span class="card-badge badge-req">WYMAGANE</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-2">
              <div class="field"><label class="field-label">Pola wrażliwe do maskowania <span class="req-star">*</span></label><textarea class="fc" rows="3" placeholder="np. PESEL, NIP, nr_konta, email" oninput="onFieldChange(this)"></textarea></div>
              <div class="field"><label class="field-label">Reguła maskowania <span class="req-star">*</span></label><textarea class="fc mono" rows="3" placeholder="np. PESEL -> ***********, email -> a***@firma.pl" oninput="onFieldChange(this)"></textarea></div>
            </div>
            <div class="field"><label class="field-label">Role uprawnień do raportu <span class="req-star">*</span></label><input type="text" class="fc" placeholder="np. CR_VIEWER, CR_MANAGER, CR_AUDITOR" oninput="onFieldChange(this)"/></div>
            <div class="field-hint"><i class="bi bi-info-circle"></i>Jak użyć w C# runtime: maskuj dane przed <code style="font-family:'JetBrains Mono',monospace">SetDataSource()</code> i waliduj role użytkownika przed wygenerowaniem raportu.</div>
          </div>
        </div>

        <div class="card card-nth-7">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-green"><i class="bi bi-globe2"></i></div>
            <span class="card-title">Lokalizacja i formatowanie</span>
            <span class="card-badge badge-req">WYMAGANE</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-3">
              <div class="field"><label class="field-label">Locale / kultura <span class="req-star">*</span></label><input type="text" class="fc mono" placeholder="np. pl-PL" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Strefa czasowa <span class="req-star">*</span></label><input type="text" class="fc" placeholder="np. Europe/Warsaw" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Format daty i liczby <span class="req-star">*</span></label><input type="text" class="fc mono" placeholder="np. dd.MM.yyyy | #,##0.00" oninput="onFieldChange(this)"/></div>
            </div>
            <div class="field-hint"><i class="bi bi-info-circle"></i>Jak użyć w C# runtime: ustaw <code style="font-family:'JetBrains Mono',monospace">CultureInfo</code> i konwertuj daty do właściwej strefy przed podaniem danych do raportu.</div>
          </div>
        </div>

        <div class="card card-nth-8">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-blue"><i class="bi bi-send-check"></i></div>
            <span class="card-title">Dystrybucja i harmonogram</span>
            <span class="card-badge badge-req">WYMAGANE</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-3">
              <div class="field"><label class="field-label">Tryb uruchamiania <span class="req-star">*</span></label><select class="fs" onchange="onFieldChange(this)"><option value="">— wybierz —</option><option>On-demand (na żądanie)</option><option>Scheduled (harmonogram)</option><option>Oba tryby</option></select></div>
              <div class="field"><label class="field-label">Kanał dystrybucji <span class="req-star">*</span></label><select class="fs" onchange="onFieldChange(this)"><option value="">— wybierz —</option><option>PDF</option><option>XLSX</option><option>E-mail (załącznik)</option><option>PDF + XLSX + e-mail</option></select></div>
              <div class="field"><label class="field-label">Harmonogram CRON / interwał <span class="req-star">*</span></label><input type="text" class="fc mono" placeholder="np. 0 0 6 * * 1-5" oninput="onFieldChange(this)"/></div>
            </div>
            <div class="field"><label class="field-label">Lista odbiorców / grupa docelowa <span class="req-star">*</span></label><textarea class="fc" rows="2" placeholder="np. finanse@firma.pl; controlling@firma.pl" oninput="onFieldChange(this)"></textarea></div>
            <div class="field-hint"><i class="bi bi-info-circle"></i>Jak użyć w C# runtime: dla on-demand wywołuj eksport synchronicznie, a dla scheduled zapisuj zlecenie do joba i wysyłaj wynik jako PDF/XLSX/mail.</div>
          </div>
        </div>

        <div class="nav-actions">
          <button class="btn-secondary" onclick="goTab('t1')"><i class="bi bi-arrow-left"></i> Wróć</button>
          <button class="btn-primary" onclick="goTab('t3')">Dalej: Kolumny <i class="bi bi-arrow-right"></i></button>
        </div>
      </div>

      <!-- ══ TAB 3 ══ -->
      <div class="tab-pane" id="t3">
        <div class="step-indicator"><div class="step-dot"></div>Krok 3 z 10</div>
        <div class="page-header"><h1>Kolumny raportu</h1><p>Zdefiniuj każdą kolumnę — pole DB, nagłówek, typ, format i reguły formatowania warunkowego.</p></div>

        <div class="card card-nth-1">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-blue"><i class="bi bi-fonts"></i></div>
            <span class="card-title">Tryb nagłówków kolumn</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="radio-group mb-2">
              <div class="rpill"><input type="radio" name="hm" id="hm1" value="static" checked onchange="setHM('static')"><label for="hm1">Statyczne</label></div>
              <div class="rpill"><input type="radio" name="hm" id="hm2" value="param" onchange="setHM('param')"><label for="hm2">Z parametru CR ({?X})</label></div>
              <div class="rpill"><input type="radio" name="hm" id="hm3" value="formula" onchange="setHM('formula')"><label for="hm3">Z formuły CR ({@X})</label></div>
              <div class="rpill"><input type="radio" name="hm" id="hm4" value="mixed" onchange="setHM('mixed')"><label for="hm4">Mieszany (per kolumna)</label></div>
            </div>
            <div class="field-hint" id="hmHint"><i class="bi bi-info-circle"></i>Statyczny nagłówek to stały tekst w CR Designer — nie zmienia się w runtime.</div>
          </div>
        </div>

        <div class="card card-nth-2">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-blue"><i class="bi bi-columns-gap"></i></div>
            <span class="card-title">Definicja kolumn</span>
            <span class="card-badge badge-req">WYMAGANE</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="dt-wrap">
              <table class="dt" id="colTable">
                <thead><tr>
                  <th></th><th>↕</th><th>#</th>
                  <th>Pole DB / formuła <i class="tip-btn" style="font-size:9px">?<span class="tip-popup">Nazwa pola z widoku/SP lub formuły CR np. {@NazwaFormuly}. Musi dokładnie odpowiadać kolumnie.</span></i></th>
                  <th>Nagłówek</th><th>Typ danych</th><th>Format / maska</th>
                  <th>Widoczna</th><th>Sumować</th><th>Wyrów.</th><th>CF</th><th></th>
                </tr></thead>
                <tbody id="colBody">
                  <tr>
                    <td><span class="drag-handle"><i class="bi bi-grip-vertical"></i></span></td>
                    <td>
                      <div class="row-move">
                        <button class="btn-move" type="button" onclick="moveColRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button>
                        <button class="btn-move" type="button" onclick="moveColRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button>
                      </div>
                    </td>
                    <td class="row-num">1</td>
                    <td><input type="text" class="mono" placeholder="total_amount"/></td>
                    <td><input type="text" placeholder="Wartość"/></td>
                    <td><select><option>—</option><option>String</option><option>Number</option><option>Currency</option><option>Date</option><option>DateTime</option><option>Boolean</option><option>Percent</option><option>Formula</option></select></td>
                    <td><input type="text" placeholder="#,##0.00"/></td>
                    <td style="text-align:center"><input type="checkbox" checked/></td>
                    <td style="text-align:center"><input type="checkbox"/></td>
                    <td><select><option>L</option><option>Ś</option><option>P</option></select></td>
                    <td><select><option>Brak</option><option>Kolor</option><option>Tło</option><option>Bold</option><option>Wiele</option></select></td>
                    <td>
                      <div class="row-actions">
                        <div class="row-move">
                          <button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button>
                          <button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button>
                        </div>
                        <button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
              <button class="btn-add" onclick="addColRow()"><i class="bi bi-plus-lg"></i>Dodaj kolumnę</button>
              <button class="btn-add" onclick="addFormulaCol()"><i class="bi bi-calculator"></i>Formula Field</button>
              <button class="btn-add" onclick="addRunningTotal()"><i class="bi bi-123"></i>Running Total</button>
            </div>
          </div>
        </div>

        <div class="card card-nth-3">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-yellow"><i class="bi bi-palette"></i></div>
            <span class="card-title">Formatowanie warunkowe (Conditional Formatting)</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="info-alert"><i class="bi bi-info-circle"></i>CR Highlighting Expert — reguły zmieniające kolor/styl komórek na podstawie wartości np. ujemne = czerwone.</div>
            <div class="dt-wrap">
              <table class="dt" id="cfTable">
                <thead><tr><th>#</th><th>Kolumna</th><th>Warunek CR <i class="tip-btn" style="font-size:9px">?<span class="tip-popup">Formuła CR np. {pole} &lt; 0 lub {pole} &gt; {?Prog}. Odwołuje się do pól i parametrów.</span></i></th><th>Efekt</th><th>Kolor tekstu</th><th>Kolor tła</th><th>Styl</th><th>Opis</th><th></th></tr></thead>
                <tbody id="cfBody">
                  <tr>
                    <td class="row-num">1</td>
                    <td><input type="text" placeholder="total_amount" class="mono"/></td>
                    <td><input type="text" placeholder="{total_amount} &lt; 0" class="mono"/></td>
                    <td><select><option>Kolor tekstu</option><option>Kolor tła</option><option>Oba</option><option>Bold</option><option>Kursywa</option></select></td>
                    <td><input type="color" value="#dc2626"/></td>
                    <td><input type="color" value="#fee2e2"/></td>
                    <td><select><option>Normal</option><option>Bold</option><option>Italic</option></select></td>
                    <td><input type="text" placeholder="Wartość ujemna"/></td>
                    <td>
                      <div class="row-actions">
                        <div class="row-move">
                          <button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button>
                          <button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button>
                        </div>
                        <button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button class="btn-add mt-3" onclick="addCFRow()"><i class="bi bi-plus-lg"></i>Dodaj regułę CF</button>
          </div>
        </div>

        <div class="nav-actions">
          <button class="btn-secondary" onclick="goTab('t2')"><i class="bi bi-arrow-left"></i> Wróć</button>
          <button class="btn-primary" onclick="goTab('t4')">Dalej: Parametry <i class="bi bi-arrow-right"></i></button>
        </div>
      </div>

      <!-- ══ TAB 4 ══ -->
      <div class="tab-pane" id="t4">
        <div class="step-indicator"><div class="step-dot"></div>Krok 4 z 10</div>
        <div class="page-header"><h1>Parametry CR</h1><p>Parametry przekazywane z kodu C# przez <code style="font-family:'JetBrains Mono',monospace;background:var(--a-l);padding:1px 6px;border-radius:4px;color:var(--a)">SetParameterValue()</code> przy uruchamianiu raportu.</p></div>
        <div class="info-alert"><i class="bi bi-info-circle"></i>Każdy parametr musi być ustawiony przed wywołaniem <code style="font-family:'JetBrains Mono',monospace">report.SetParameterValue("Nazwa", wartość)</code>. Kontrolki UI w Razor Pages automatycznie mapowane na parametry.</div>
        <div class="card card-nth-1">
          <div class="card-head"><div class="card-ico ci-blue"><i class="bi bi-sliders"></i></div><span class="card-title">Lista parametrów</span></div>
          <div class="card-body">
            <div class="dt-wrap">
              <table class="dt">
                <thead><tr><th>#</th><th>Nazwa CR <i class="tip-btn" style="font-size:9px">?<span class="tip-popup">Bez {?}. Identyczna z argumentem SetParameterValue(). Bez spacji i polskich znaków.</span></i></th><th>Typ</th><th>Domyślna <i class="tip-btn" style="font-size:9px">?<span class="tip-popup">Wartość gdy użytkownik nie poda własnej. {dziś-30d} = aktualna data minus 30 dni.</span></i></th><th>Wymagany</th><th>Multi</th><th>Kontrolka UI</th><th>LOV SQL</th><th>Opis</th><th></th></tr></thead>
                <tbody id="paramBody">
                  <tr>
                    <td class="row-num">1</td>
                    <td><input type="text" placeholder="DataOd" class="mono"/></td>
                    <td><select><option>—</option><option>String</option><option>Number</option><option>Date</option><option>DateTime</option><option>Boolean</option></select></td>
                    <td><input type="text" placeholder="{dziś-30d}"/></td>
                    <td style="text-align:center"><input type="checkbox"/></td>
                    <td style="text-align:center"><input type="checkbox"/></td>
                    <td><select><option>DatePicker</option><option>TextBox</option><option>Dropdown</option><option>MultiSelect</option><option>Ukryta</option></select></td>
                    <td><input type="text" class="mono" placeholder="SELECT id,nazwa FROM..."/></td>
                    <td><input type="text" placeholder="Opis"/></td>
                    <td>
                      <div class="row-actions">
                        <div class="row-move">
                          <button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button>
                          <button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button>
                        </div>
                        <button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button class="btn-add mt-3" onclick="addParamRow()"><i class="bi bi-plus-lg"></i>Dodaj parametr</button>
          </div>
        </div>
        <div class="nav-actions">
          <button class="btn-secondary" onclick="goTab('t3')"><i class="bi bi-arrow-left"></i> Wróć</button>
          <button class="btn-primary" onclick="goTab('t5')">Dalej: Filtry <i class="bi bi-arrow-right"></i></button>
        </div>
      </div>

      <!-- ══ TAB 5 ══ -->
      <div class="tab-pane" id="t5">
        <div class="step-indicator"><div class="step-dot"></div>Krok 5 z 10</div>
        <div class="page-header"><h1>Filtry i selekcja</h1><p>Warunki filtrowania na poziomie SQL WHERE lub CR Record Selection Formula.</p></div>
        <div class="card card-nth-1">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-green"><i class="bi bi-layers"></i></div>
            <span class="card-title">Strategia filtrowania</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="radio-group">
              <div class="rpill"><input type="radio" name="fs" id="fs1" checked><label for="fs1">SQL WHERE (push-down)</label></div>
              <div class="rpill"><input type="radio" name="fs" id="fs2"><label for="fs2">CR Record Selection</label></div>
              <div class="rpill"><input type="radio" name="fs" id="fs3"><label for="fs3">Oba poziomy</label></div>
              <div class="rpill"><input type="radio" name="fs" id="fs4"><label for="fs4">CR Group Selection</label></div>
            </div>
            <div class="field-hint mt-2"><i class="bi bi-info-circle"></i><strong>SQL WHERE</strong> = filtruje w bazie (wydajne). <strong>CR Selection</strong> = po stronie CR — gdy nie możesz modyfikować bazy. <strong>Group Selection</strong> = odpowiednik HAVING.</div>
          </div>
        </div>
        <div class="card card-nth-2">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-green"><i class="bi bi-diagram-3"></i></div>
            <span class="card-title">Builder warunków (AND/OR)</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div id="filterGroups"></div>
            <button class="btn-add" onclick="addFilterGroup()"><i class="bi bi-plus-square"></i>Dodaj grupę AND/OR</button>
          </div>
        </div>
        <div class="card card-nth-3">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-green"><i class="bi bi-code-square"></i></div>
            <span class="card-title">CR Selection Formula (ręczna)</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="field mb-3">
              <label class="field-label">CR Record Selection Formula <i class="tip-btn">?<span class="tip-popup">Nadpisuje builder. Składnia Crystal Syntax. Widoczna w CR Designer → Report → Edit Selection Formula → Record.</span></i></label>
              <textarea class="fc mono" rows="3" placeholder='{Orders.OrderDate} in {?DataOd} to {?DataDo} and {Orders.Status} = "AKTYWNY"'></textarea>
            </div>
            <div class="field">
              <label class="field-label">CR Group Selection Formula <i class="tip-btn">?<span class="tip-popup">Filtruje grupy po agregacji — odpowiednik SQL HAVING. CR Designer → Report → Edit Selection Formula → Group.</span></i></label>
              <textarea class="fc mono" rows="2" placeholder="Sum({Orders.Kwota}, {Orders.Kategoria}) > 10000"></textarea>
            </div>
          </div>
        </div>
        <div class="nav-actions">
          <button class="btn-secondary" onclick="goTab('t4')"><i class="bi bi-arrow-left"></i> Wróć</button>
          <button class="btn-primary" onclick="goTab('t6')">Dalej: Grupowanie <i class="bi bi-arrow-right"></i></button>
        </div>
      </div>

      <!-- ══ TAB 6 ══ -->
      <div class="tab-pane" id="t6">
        <div class="step-indicator"><div class="step-dot"></div>Krok 6 z 10</div>
        <div class="page-header"><h1>Grupowanie i sortowanie</h1><p>Hierarchia grupowania CR — Group Headers, Footers i podsumowania per poziom.</p></div>
        <div class="card card-nth-1">
          <div class="card-head"><div class="card-ico ci-yellow"><i class="bi bi-collection"></i></div><span class="card-title">Poziomy grupowania</span></div>
          <div class="card-body">
            <div class="info-alert"><i class="bi bi-info-circle"></i>Grupy są hierarchiczne — Grupa 1 jest nadrzędna. CR automatycznie tworzy Group Header i Footer. Maks. 5 poziomów.</div>
            <div class="dt-wrap">
              <table class="dt">
                <thead><tr><th>#</th><th>Pole grupowania</th><th>Kolejność</th><th>Podsumowanie</th><th>Pole sumy</th><th>PageBreak</th><th>Ukryj detal</th><th>Nagłówek</th><th>Stopka</th><th></th></tr></thead>
                <tbody id="groupBody">
                  <tr>
                    <td class="row-num">1</td>
                    <td><input type="text" placeholder="kategoria" class="mono"/></td>
                    <td><select><option>ASC</option><option>DESC</option><option>Custom</option></select></td>
                    <td><select><option>Brak</option><option>SUM</option><option>COUNT</option><option>AVG</option><option>MIN</option><option>MAX</option></select></td>
                    <td><input type="text" placeholder="pole_kwota" class="mono"/></td>
                    <td style="text-align:center"><input type="checkbox"/></td>
                    <td style="text-align:center"><input type="checkbox"/></td>
                    <td><input type="text" placeholder="Kategoria: {pole}"/></td>
                    <td><input type="text" placeholder="Razem: {SUM}"/></td>
                    <td>
                      <div class="row-actions">
                        <div class="row-move">
                          <button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button>
                          <button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button>
                        </div>
                        <button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button class="btn-add mt-3" onclick="addGroupRow()"><i class="bi bi-plus-lg"></i>Dodaj poziom grupowania</button>
          </div>
        </div>
        <div class="nav-actions">
          <button class="btn-secondary" onclick="goTab('t5')"><i class="bi bi-arrow-left"></i> Wróć</button>
          <button class="btn-primary" onclick="goTab('t7')">Dalej: Podraporty <i class="bi bi-arrow-right"></i></button>
        </div>
      </div>

      <!-- ══ TAB 7 ══ -->
      <div class="tab-pane" id="t7">
        <div class="step-indicator"><div class="step-dot"></div>Krok 7 z 10</div>
        <div class="page-header"><h1>Podraporty (Subreports)</h1><p>Osadzone raporty z własnym źródłem danych, powiązane z raportem głównym przez SubreportLinks.</p></div>
        <div class="form-row cols-2 mb-3">
          <div class="info-alert m-0"><i class="bi bi-check-circle"></i><div><strong>Kiedy używać:</strong> inne źródło danych, inna granularność (nagłówek + pozycje), drill-down on-demand.</div></div>
          <div class="warn-alert m-0"><i class="bi bi-exclamation-triangle"></i><div><strong>Uwaga wydajnościowa:</strong> każdy SR = osobne zapytanie SQL. Rozważ JOIN lub PIVOT zamiast podraportu.</div></div>
        </div>
        <div id="subreportList"></div>
        <button class="btn-add" onclick="addSubreport()"><i class="bi bi-plus-lg"></i>Dodaj podraport</button>
        <div class="nav-actions">
          <button class="btn-secondary" onclick="goTab('t6')"><i class="bi bi-arrow-left"></i> Wróć</button>
          <button class="btn-primary" onclick="goTab('t8')">Dalej: Nagłówki/Stopki <i class="bi bi-arrow-right"></i></button>
        </div>
      </div>

      <!-- ══ TAB 8 ══ -->
      <div class="tab-pane" id="t8">
        <div class="step-indicator"><div class="step-dot"></div>Krok 8 z 10</div>
        <div class="page-header"><h1>Nagłówki i stopki</h1><p>Skonfiguruj 4 strefy CR: Report Header, Page Header, Page Footer, Report Footer.</p></div>
        <div class="card card-nth-1">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-green"><i class="bi bi-braces"></i></div>
            <span class="card-title">Tokeny dynamiczne</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="field-hint mb-2"><i class="bi bi-info-circle"></i>Kliknij token aby wstawić do ostatnio aktywnego pola tekstowego.</div>
            <div class="token-chips">
              <span class="tchip" onclick="insertToken('{PageNumber}')">{PageNumber}</span>
              <span class="tchip" onclick="insertToken('{TotalPages}')">{TotalPages}</span>
              <span class="tchip" onclick="insertToken('{PrintDate}')">{PrintDate}</span>
              <span class="tchip" onclick="insertToken('{PrintTime}')">{PrintTime}</span>
              <span class="tchip" onclick="insertToken('{ReportName}')">{ReportName}</span>
              <span class="tchip g" onclick="insertToken('{?DataOd}')">{?DataOd}</span>
              <span class="tchip g" onclick="insertToken('{?DataDo}')">{?DataDo}</span>
              <span class="tchip g" onclick="insertToken('{?Użytkownik}')">{?Użytkownik}</span>
              <span class="tchip y" onclick="insertToken('{@TytułRaportu}')">{@TytułRaportu}</span>
              <span class="tchip y" onclick="insertToken('{@NazwaFirmy}')">{@NazwaFirmy}</span>
            </div>
          </div>
        </div>

        <!-- Report Header -->
        <div class="hf-zone">
          <div class="hf-zone-head hf-rh" onclick="toggleHF(this)">
            <i class="bi bi-file-earmark-text"></i><strong>Report Header</strong> — raz, na początku pierwszej strony
            <i class="bi bi-chevron-down hf-chevron"></i>
          </div>
          <div class="hf-body">
            <div class="form-row cols-2">
              <div class="field"><label class="field-label">Główny tytuł <span class="req-star">*</span> <i class="tip-btn">?<span class="tip-popup">Tytuł widoczny na początku raportu — duża czcionka, raz. Może zawierać tokeny CR.</span></i></label><input type="text" class="fc" id="rhTitle" placeholder="RAPORT SPRZEDAŻY — {?Miesiąc} {?Rok}" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Podtytuł / zakres <i class="tip-btn">?<span class="tip-popup">Linia pod tytułem — zakres dat, aktywne filtry.</span></i></label><input type="text" class="fc" placeholder="Okres: {?DataOd} — {?DataDo}" oninput="onFieldChange(this)"/></div>
            </div>
            <div class="form-row cols-3">
              <div class="field"><label class="field-label">Logo firmy</label><select class="fs"><option>Brak</option><option>Embedded w .rpt</option><option>Dynamiczne (BLOB)</option><option>Ścieżka UNC</option></select></div>
              <div class="field"><label class="field-label">Pozycja logo</label><select class="fs"><option>Lewy górny</option><option>Prawy górny</option><option>Środek</option></select></div>
              <div class="field"><label class="field-label">RH na osobnej stronie</label><select class="fs"><option>Nie</option><option>Tak (New Page After)</option></select></div>
            </div>
            <div class="field"><label class="field-label">Elementy dodatkowe <i class="tip-btn">?<span class="tip-popup">Nota prawna, klauzula poufności, numer wersji, dział zamawiający.</span></i></label><textarea class="fc" rows="2" placeholder="np. Dokument poufny — do użytku wewnętrznego. Dział: Sprzedaż." oninput="onFieldChange(this)"></textarea></div>
          </div>
        </div>

        <!-- Page Header -->
        <div class="hf-zone">
          <div class="hf-zone-head hf-ph" onclick="toggleHF(this)">
            <i class="bi bi-layout-text-window"></i><strong>Page Header</strong> — powtarzany na każdej stronie
            <i class="bi bi-chevron-down hf-chevron"></i>
          </div>
          <div class="hf-body">
            <div class="form-row cols-3">
              <div class="field"><label class="field-label">Lewo</label><input type="text" class="fc" placeholder="ABC Sp. z o.o." oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Środek</label><input type="text" class="fc" placeholder="Raport Sprzedaży" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Prawo</label><input type="text" class="fc" placeholder="Wydrukowano: {PrintDate}" oninput="onFieldChange(this)"/></div>
            </div>
            <div class="form-row cols-2">
              <div class="field"><label class="field-label">Linia oddzielająca</label><select class="fs"><option>Brak</option><option>Cienka</option><option>Gruba</option><option>Podwójna</option></select></div>
              <div class="field"><label class="field-label">Nagłówki kolumn w PH</label><select class="fs"><option>Powtarzaj na każdej stronie</option><option>Tylko pierwsza strona</option><option>Nie</option></select></div>
            </div>
            <div class="toggle-row"><label class="toggle-sw"><input type="checkbox"><div class="toggle-track"><div class="toggle-thumb"></div></div></label><span class="toggle-label">Ukryj PH na pierwszej stronie <i class="tip-btn" style="vertical-align:middle">?<span class="tip-popup">Suppress PH on first page — bo pierwsza strona ma już Report Header. CR: {PageNumber} = 1 → Suppress.</span></i></span></div>
          </div>
        </div>

        <!-- Page Footer -->
        <div class="hf-zone">
          <div class="hf-zone-head hf-pf" onclick="toggleHF(this)">
            <i class="bi bi-layout-text-window-reverse"></i><strong>Page Footer</strong> — powtarzany na każdej stronie
            <i class="bi bi-chevron-down hf-chevron"></i>
          </div>
          <div class="hf-body">
            <div class="form-row cols-3">
              <div class="field"><label class="field-label">Lewo</label><input type="text" class="fc" placeholder="© 2024 Firma" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Środek</label><input type="text" class="fc" placeholder="Poufne" oninput="onFieldChange(this)"/></div>
              <div class="field"><label class="field-label">Prawo (numeracja) <i class="tip-btn">?<span class="tip-popup">Format numeracji stron. {PageNumber} i {TotalPages} są polami CR.</span></i></label><input type="text" class="fc" placeholder="Strona {PageNumber} / {TotalPages}" oninput="onFieldChange(this)"/></div>
            </div>
          </div>
        </div>

        <!-- Report Footer -->
        <div class="hf-zone">
          <div class="hf-zone-head hf-rf" onclick="toggleHF(this)">
            <i class="bi bi-file-earmark-check"></i><strong>Report Footer</strong> — raz, po wszystkich danych (ostatnia strona)
            <i class="bi bi-chevron-down hf-chevron"></i>
          </div>
          <div class="hf-body">
            <div class="form-row cols-2">
              <div class="field"><label class="field-label">Tekst podsumowujący <i class="tip-btn">?<span class="tip-popup">Tekst na końcu raportu np. "Koniec raportu. Liczba rekordów: {RecordCount}."</span></i></label><textarea class="fc" rows="2" placeholder="Koniec raportu. Liczba rekordów: {RecordCount}." oninput="onFieldChange(this)"></textarea></div>
              <div class="field"><label class="field-label">Agregaty globalne <i class="tip-btn">?<span class="tip-popup">Podsumowanie finansowe całego raportu. CR Summary Fields dostępne automatycznie.</span></i></label><textarea class="fc" rows="2" placeholder="SUMA: {SUM_kwota}  |  LICZBA: {COUNT}" oninput="onFieldChange(this)"></textarea></div>
            </div>
          </div>
        </div>

        <div class="nav-actions">
          <button class="btn-secondary" onclick="goTab('t7')"><i class="bi bi-arrow-left"></i> Wróć</button>
          <button class="btn-primary" onclick="goTab('t9')">Dalej: Brak danych <i class="bi bi-arrow-right"></i></button>
        </div>
      </div>

      <!-- ══ TAB 9 ══ -->
      <div class="tab-pane" id="t9">
        <div class="step-indicator"><div class="step-dot"></div>Krok 9 z 10</div>
        <div class="page-header"><h1>Zachowanie przy braku danych</h1><p>Zdefiniuj co widzi użytkownik gdy zapytanie nie zwróci żadnych rekordów.</p></div>
        <div class="card card-nth-1">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-red"><i class="bi bi-sliders"></i></div>
            <span class="card-title">Strategia</span>
            <span class="card-badge badge-ux">UX</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="radio-group">
              <div class="rpill"><input type="radio" name="em" id="em1" checked><label for="em1">Komunikat w CR</label></div>
              <div class="rpill"><input type="radio" name="em" id="em2"><label for="em2">Pusta tabela z nagłówkami</label></div>
              <div class="rpill"><input type="radio" name="em" id="em3"><label for="em3">Komunikat w UI</label></div>
              <div class="rpill"><input type="radio" name="em" id="em4"><label for="em4">Przekieruj do błędu</label></div>
            </div>
          </div>
        </div>
        <div class="card card-nth-2">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-red"><i class="bi bi-chat-square-text"></i></div>
            <span class="card-title">Treść komunikatu</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-2">
              <div class="field"><label class="field-label">Główny tekst <i class="tip-btn">?<span class="tip-popup">Krótki, jasny komunikat dla użytkownika. Max 1-2 zdania. Bez technicznego żargonu.</span></i></label><input type="text" class="fc" id="emptyMsg" placeholder="Brak danych dla wybranych kryteriów." oninput="updateEmptyPreview()"/></div>
              <div class="field"><label class="field-label">Ikona</label><select class="fs" id="emptyIcon" onchange="updateEmptyPreview()"><option value="bi-inbox">📭 Folder pusty</option><option value="bi-search">🔍 Brak wyników</option><option value="bi-exclamation-circle">⚠️ Ostrzeżenie</option><option value="bi-database-x">💾 Brak danych</option></select></div>
            </div>
            <div class="field mb-3"><label class="field-label">Wskazówka <i class="tip-btn">?<span class="tip-popup">Podpowiedź co zrobić — zmień filtry, skontaktuj się z adminem, sprawdź datę.</span></i></label><input type="text" class="fc" id="emptyHint" placeholder="Spróbuj poszerzyć zakres dat lub zmienić kryteria." oninput="updateEmptyPreview()"/></div>
            <div class="es-preview" id="emptyPreview">
              <span class="es-icon"><i class="bi bi-inbox"></i></span>
              <div class="es-title">Brak danych dla wybranych kryteriów.</div>
              <div class="es-sub">Spróbuj poszerzyć zakres dat lub zmienić kryteria.</div>
            </div>
          </div>
        </div>
        <div class="nav-actions">
          <button class="btn-secondary" onclick="goTab('t8')"><i class="bi bi-arrow-left"></i> Wróć</button>
          <button class="btn-primary" onclick="goTab('t10')">Dalej: Opcje wyjścia <i class="bi bi-arrow-right"></i></button>
        </div>
      </div>

      <!-- ══ TAB 10 ══ -->
      <div class="tab-pane" id="t10">
        <div class="step-indicator"><div class="step-dot"></div>Krok 10 z 10 — Ostatni krok!</div>
        <div class="page-header"><h1>Opcje wyjścia i eksport</h1><p>Zdefiniuj obsługiwane formaty eksportu z indywidualnymi ustawieniami dla każdego.</p></div>

        <div class="card card-nth-1">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-green"><i class="bi bi-file-earmark-arrow-down"></i></div>
            <span class="card-title">Formaty eksportu</span>
            <span class="card-badge badge-req">WYMAGANE</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body" id="fmtContainer">
            <!-- PDF -->
            <div class="fmt-card">
              <div class="fmt-head" onclick="toggleFmt(this)">
                <div class="fmt-ico fmt-pdf"><i class="bi bi-filetype-pdf"></i></div>
                <span class="fmt-name">PDF</span>
                <div style="display:flex;align-items:center;gap:6px;margin-left:auto" onclick="event.stopPropagation()">
                  <label class="toggle-sw" style="width:32px;height:18px"><input class="fmt-cb" id="fmtPdfEnabled" type="checkbox" checked onchange="onFieldChange(this)"><div class="toggle-track"><div class="toggle-thumb" style="width:12px;height:12px;top:3px;left:3px"></div></div></label>
                  <span style="font-size:12px;font-weight:600;color:var(--muted)">Aktywny</span>
                </div>
                <i class="bi bi-chevron-down fmt-chevron ms-2"></i>
              </div>
              <div class="fmt-body open">
                <div class="form-row auto">
                  <div class="field"><label class="field-label">Orientacja <i class="tip-btn">?<span class="tip-popup">Auto = CR dobiera wg szerokości. Landscape dla szerokich tabel.</span></i></label><select class="fs"><option>Portrait</option><option>Landscape</option><option>Auto</option></select></div>
                  <div class="field"><label class="field-label">Papier</label><select class="fs"><option>A4</option><option>A3</option><option>Letter</option><option>Legal</option></select></div>
                  <div class="field"><label class="field-label">Marginesy G/P/D/L (mm) <i class="tip-btn">?<span class="tip-popup">CR: File → Page Setup → Margins. Standard: 10/10/10/10.</span></i></label><input type="text" class="fc" placeholder="10/10/10/10"/></div>
                  <div class="field"><label class="field-label">Wersja PDF <i class="tip-btn">?<span class="tip-popup">PDF/A-1b = standard archiwizacyjny wymagany w administracji publicznej. Wymaga osadzenia czcionek.</span></i></label><select class="fs"><option>PDF 1.4 (domyślny CR)</option><option>PDF/A-1b (archiwizacja)</option><option>PDF/A-2</option></select></div>
                  <div class="field"><label class="field-label">DPI <i class="tip-btn">?<span class="tip-popup">96=ekran, 300=druk, 600=druk profesjonalny. Dla tekstowych raportów 150 DPI wystarczy.</span></i></label><select class="fs"><option>96 DPI</option><option>150 DPI</option><option>300 DPI</option><option>600 DPI</option></select></div>
                  <div class="field"><label class="field-label">Wzorzec nazwy <i class="tip-btn">?<span class="tip-popup">Programista interpoluje tokeny w C# przed ExportToStream.</span></i></label><input type="text" class="fc mono" id="pdfFilePattern" placeholder="Raport_{?Miesiąc}_{PrintDate}.pdf" minlength="5" pattern=".*\.pdf$" oninput="onFieldChange(this)"/></div>
                </div>
              </div>
            </div>
            <!-- Excel -->
            <div class="fmt-card">
              <div class="fmt-head" onclick="toggleFmt(this)">
                <div class="fmt-ico fmt-xls"><i class="bi bi-filetype-xlsx"></i></div>
                <span class="fmt-name">Excel (.xlsx)</span>
                <div style="display:flex;align-items:center;gap:6px;margin-left:auto" onclick="event.stopPropagation()">
                  <label class="toggle-sw" style="width:32px;height:18px"><input class="fmt-cb" id="fmtExcelEnabled" type="checkbox" onchange="onFieldChange(this)"><div class="toggle-track"><div class="toggle-thumb" style="width:12px;height:12px;top:3px;left:3px"></div></div></label>
                  <span style="font-size:12px;font-weight:600;color:var(--muted)">Aktywny</span>
                </div>
                <i class="bi bi-chevron-down fmt-chevron ms-2"></i>
              </div>
              <div class="fmt-body">
                <div class="form-row auto">
                  <div class="field"><label class="field-label">Format Excel <i class="tip-btn">?<span class="tip-popup">Data Only = surowe dane bez formatowania CR — lepsza edytowalność w Excel.</span></i></label><select class="fs"><option>XLSX</option><option>XLSX Data Only</option><option>XLS</option></select></div>
                  <div class="field"><label class="field-label">Arkusz</label><input type="text" class="fc" placeholder="Dane lub {?Miesiąc}"/></div>
                  <div class="field"><label class="field-label">Wzorzec nazwy</label><input type="text" class="fc mono" id="excelFilePattern" placeholder="Raport_{PrintDate}.xlsx" minlength="5" pattern=".*\.xlsx?$" oninput="onFieldChange(this)"/></div>
                </div>
                <div class="form-row cols-3" style="margin-top:10px">
                  <div class="toggle-row"><label class="toggle-sw"><input type="checkbox" checked><div class="toggle-track"><div class="toggle-thumb"></div></div></label><span class="toggle-label">AutoFilter <i class="tip-btn" style="vertical-align:middle">?<span class="tip-popup">Rozwijane filtry Excel. Implementacja przez EPPlus/ClosedXML po eksporcie CR.</span></i></span></div>
                  <div class="toggle-row"><label class="toggle-sw"><input type="checkbox"><div class="toggle-track"><div class="toggle-thumb"></div></div></label><span class="toggle-label">Freeze nagłówka <i class="tip-btn" style="vertical-align:middle">?<span class="tip-popup">Freeze Pane = zamrożenie pierwszego wiersza. EPPlus v5+.</span></i></span></div>
                </div>
              </div>
            </div>
            <!-- CSV -->
            <div class="fmt-card">
              <div class="fmt-head" onclick="toggleFmt(this)">
                <div class="fmt-ico fmt-csv"><i class="bi bi-filetype-csv"></i></div>
                <span class="fmt-name">CSV / Tekst</span>
                <div style="display:flex;align-items:center;gap:6px;margin-left:auto" onclick="event.stopPropagation()">
                  <label class="toggle-sw" style="width:32px;height:18px"><input class="fmt-cb" id="fmtCsvEnabled" type="checkbox" onchange="onFieldChange(this)"><div class="toggle-track"><div class="toggle-thumb" style="width:12px;height:12px;top:3px;left:3px"></div></div></label>
                  <span style="font-size:12px;font-weight:600;color:var(--muted)">Aktywny</span>
                </div>
                <i class="bi bi-chevron-down fmt-chevron ms-2"></i>
              </div>
              <div class="fmt-body">
                <div class="form-row auto">
                  <div class="field"><label class="field-label">Separator <i class="tip-btn">?<span class="tip-popup">Średnik (;) = standard PL Excel. Przecinek (,) = EN. Tabulator dla legacy.</span></i></label><select class="fs"><option>Średnik (;)</option><option>Przecinek (,)</option><option>Tabulator (\t)</option><option>Pionowa kreska (|)</option></select></div>
                  <div class="field"><label class="field-label">Encoding <i class="tip-btn">?<span class="tip-popup">UTF-8 BOM = zalecane dla polskich znaków w Excel. BOM = Excel wykrywa kodowanie automatycznie.</span></i></label><select class="fs"><option>UTF-8 BOM</option><option>UTF-8</option><option>Windows-1250</option></select></div>
                  <div class="field"><label class="field-label">Format daty</label><input type="text" class="fc" placeholder="yyyy-MM-dd"/></div>
                  <div class="field"><label class="field-label">Wzorzec nazwy</label><input type="text" class="fc mono" id="csvFilePattern" placeholder="Raport_{PrintDate}.csv" minlength="5" pattern=".*\.csv$" oninput="onFieldChange(this)"/></div>
                </div>
              </div>
            </div>
            <button class="btn-add mt-3" onclick="addFmtCard()"><i class="bi bi-plus-lg"></i>Dodaj format</button>
          </div>
        </div>

        <div class="card card-nth-2">
          <div class="card-head collapsible" onclick="toggleCard(this)">
            <div class="card-ico ci-green"><i class="bi bi-gear"></i></div>
            <span class="card-title">Ogólne opcje dostarczania</span>
            <i class="bi bi-chevron-down collapse-chevron ms-auto"></i>
          </div>
          <div class="card-body">
            <div class="form-row cols-3">
              <div class="field"><label class="field-label">Domyślny format <span class="req-star">*</span></label><select class="fs" id="defaultExportFormat" required onchange="onFieldChange(this)"><option value="">— wybierz —</option><option>PDF</option><option>Excel</option><option>CSV</option></select></div>
              <div class="field"><label class="field-label">Widoczność <i class="tip-btn">?<span class="tip-popup">Podgląd = CrystalReportViewer w Razor Page. Tylko eksport = bezpośrednie pobranie bez podglądu.</span></i></label><select class="fs"><option>Podgląd w przeglądarce</option><option>Tylko eksport</option><option>Oba tryby</option></select></div>
              <div class="field"><label class="field-label">Harmonogram <i class="tip-btn">?<span class="tip-popup">Automatyczne generowanie. Wymaga Hangfire, Quartz.NET lub Windows Scheduler.</span></i></label><select class="fs"><option>Na żądanie</option><option>Codziennie</option><option>Co tydzień</option><option>Ostatni dzień miesiąca</option><option>Niestandardowy (CRON)</option></select></div>
            </div>
          </div>
        </div>

        <div class="nav-actions">
          <button class="btn-secondary" onclick="goTab('t9')"><i class="bi bi-arrow-left"></i> Wróć</button>
          <button class="btn-primary" onclick="toggleSummary();showToast('Definicja gotowa! Sprawdź podsumowanie.','success')"><i class="bi bi-check-circle"></i>Zakończ i podgląd</button>
        </div>
      </div>

      </div><!-- end .tab-content -->
    </form>
  </main>

  <!-- ═══ SUMMARY PANEL ═══ -->
  <button class="summary-backdrop" id="summaryBackdrop" type="button" onclick="toggleSummary(false)" aria-label="Zamknij podsumowanie"></button>
  <aside class="summary-panel" id="summaryPanel">
    <div class="sum-panel-head">
      <span class="sum-panel-title"><i class="bi bi-clipboard-data me-2"></i>Podsumowanie</span>
      <div class="sum-panel-head-actions">
        <label class="sum-compact-toggle" for="summaryCompactToggle">
          <input id="summaryCompactToggle" type="checkbox" onchange="setSummaryCompact(this.checked)">
          <span>Tryb kompaktowy</span>
        </label>
        <button class="sum-panel-close" data-summary-toggle onclick="toggleSummary()"><i class="bi bi-x-lg"></i></button>
      </div>
    </div>
    <div class="sum-panel-body" id="sumPanelBody">
      <div class="sum-score">
        <div class="score-ring">
          <svg width="90" height="90" viewBox="0 0 90 90">
            <circle cx="45" cy="45" r="38" fill="none" stroke="#e2e8f0" stroke-width="8"/>
            <circle id="scoreCircle" cx="45" cy="45" r="38" fill="none" stroke="url(#scoreGrad)" stroke-width="8" stroke-linecap="round" stroke-dasharray="239" stroke-dashoffset="239"/>
            <defs>
              <linearGradient id="scoreGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#2563eb"/>
                <stop offset="100%" stop-color="#059669"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="score-pct"><span class="pct-num" id="scorePct">0%</span><span class="pct-lbl">gotowe</span></div>
        </div>
        <div class="score-status-txt" id="scoreStatusTxt" style="color:var(--muted)">Uzupełnij pola aby śledzić postęp</div>
      </div>

      <div class="sum-section" id="sumSectionTabs">
        <button class="sum-accordion-btn" type="button" onclick="toggleSummarySection('sumSectionTabs')">
          <span>Zakładki</span><i class="bi bi-chevron-down"></i>
        </button>
        <div class="sum-section-body">
          <div id="sumTabList"></div>
          <div class="sum-detail" style="margin-top:8px">
            <div class="sum-detail-label">Szybkie akcje</div>
            <div class="sum-detail-val" style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="tchip" type="button" onclick="goTab('t1');toggleSummary(false)"><i class="bi bi-pencil-square"></i> Edytuj metadane</button>
              <button class="tchip g" type="button" onclick="goTab('t10');toggleSummary(false)"><i class="bi bi-filetype-pdf"></i> Eksport</button>
            </div>
          </div>
        </div>
      </div>

      <div class="sum-section" id="sumSectionDetails">
        <button class="sum-accordion-btn" type="button" onclick="toggleSummarySection('sumSectionDetails')">
          <span>Szczegóły</span><i class="bi bi-chevron-down"></i>
        </button>
        <div class="sum-section-body">
          <div id="sumDetails"></div>
        </div>
      </div>

      <div class="sum-section" id="sumSectionAlerts">
        <button class="sum-accordion-btn" type="button" onclick="toggleSummarySection('sumSectionAlerts')">
          <span>Alerty</span><i class="bi bi-chevron-down"></i>
        </button>
        <div class="sum-section-body">
          <div id="sumAlerts"></div>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;flex-direction:column;gap:8px">
        <button class="btn-primary" id="generateDocumentationBtn" type="button" style="width:100%;justify-content:center" onclick="validateBeforeSubmit()"><i class="bi bi-file-earmark-text"></i>Generuj dokumentację</button>
        <button class="btn-secondary" style="width:100%;justify-content:center" onclick="showToast('Dane skopiowane!','success')"><i class="bi bi-clipboard"></i>Kopiuj jako JSON</button>
      </div>
    </div>
  </aside>

</div><!-- end .shell -->

<!-- ═══ FOOTER BAR ═══ -->
<div class="footer-bar" id="footerBar">
  <div class="footer-info">
    <span class="footer-step" id="footerStep">01</span>
    <span id="footerStepName">Informacje ogólne</span>
  </div>
  <div class="footer-actions">
    <button class="tb-btn" onclick="toggleSidebar()"><i class="bi bi-layout-sidebar"></i></button>
    <button class="tb-btn" onclick="startNewForm()"><i class="bi bi-plus-square"></i><span>Nowy</span></button>
    <button class="tb-btn" onclick="saveFormToJson()"><i class="bi bi-download"></i><span>Zapisz JSON</span></button>
    <button class="tb-btn" onclick="triggerJsonLoad()"><i class="bi bi-upload"></i><span>Wczytaj JSON</span></button>
    <button class="tb-btn" data-summary-toggle onclick="toggleSummary()"><i class="bi bi-panel-split"></i><span>Podsumowanie</span></button>
    <button class="tb-btn" id="quickFixCta" style="display:none" onclick="topPriorityError && goToField(topPriorityError.tab, topPriorityError.fieldId)"><i class="bi bi-magic"></i><span>Przejdź i popraw</span></button>
    <button class="btn-primary" onclick="showToast('Szkic zapisany!','success')"><i class="bi bi-save"></i><span>Zapisz</span></button>
  </div>
</div>

<div id="globalTip" class="global-tip" aria-hidden="true"></div>

<!-- ═══ TOAST CONTAINER ═══ -->
<div class="toast-container" id="toastContainer"></div>

<!-- ═══════════════ JAVASCRIPT ═══════════════ -->
<script>
// ── GLOBAL STATE ──
const TABS = [
  {id:'t1',name:'Informacje ogólne',required:['rName','rTitle','rDesc'],completionCheck:'required'},
  {id:'t2',name:'Źródło SQL',required:['sqlType'],completionCheck:'required'},
  {id:'t3',name:'Kolumny',required:[],completionCheck:'columns'},
  {id:'t4',name:'Parametry',required:[],completionCheck:'params'},
  {id:'t5',name:'Filtry',required:[],completionCheck:'filters'},
  {id:'t6',name:'Grupowanie',required:[],completionCheck:'groups'},
  {id:'t7',name:'Podraporty',required:[],completionCheck:'subreports'},
  {id:'t8',name:'Nagłówki/Stopki',required:['rhTitle'],completionCheck:'required'},
  {id:'t9',name:'Brak danych',required:['emptyMsg'],completionCheck:'required'},
  {id:'t10',name:'Opcje wyjścia',required:[],completionCheck:'exports'},
];
const STEP_NAMES = TABS.map(t=>t.name);
let sidebarOpen = true;
let summaryOpen = false;
let summaryCompact = false;
let currentTab = 't1';
let activeTipBtn = null;
let summaryCloseTimer = null;
const themeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

function applyAutoTheme(event){
  const prefersDark = typeof event?.matches === 'boolean' ? event.matches : themeMediaQuery.matches;
  document.body.classList.toggle('theme-dark', prefersDark);
}

function setTheme(mode){
  const themeMode = mode === 'dark' || mode === 'auto' ? mode : 'light';
  themeMediaQuery.removeEventListener('change', applyAutoTheme);

  if(themeMode === 'auto'){
    applyAutoTheme();
    themeMediaQuery.addEventListener('change', applyAutoTheme);
  } else {
    document.body.classList.toggle('theme-dark', themeMode === 'dark');
  }

  document.getElementById('themeLightBtn').classList.toggle('active', themeMode === 'light');
  document.getElementById('themeDarkBtn').classList.toggle('active', themeMode === 'dark');
  document.getElementById('themeAutoBtn').classList.toggle('active', themeMode === 'auto');
  localStorage.setItem('rf-theme', themeMode);
}

function initTheme(){
  const saved = localStorage.getItem('rf-theme');
  const initial = saved === 'dark' || saved === 'auto' ? saved : 'light';
  setTheme(initial);
}

function getTipText(btn){
  const popup = btn.querySelector('.tip-popup');
  return popup ? popup.textContent.trim() : '';
}

function updateTipAria(btn, expanded){
  const hasText = !!getTipText(btn);
  btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
  btn.setAttribute('aria-label', expanded ? 'Ukryj podpowiedź' : (hasText ? `Pokaż podpowiedź: ${getTipText(btn)}` : 'Pokaż podpowiedź'));
}

function showGlobalTip(btn){
  const tipEl = document.getElementById('globalTip');
  const text = getTipText(btn);
  if(!tipEl || !text) return;
  const popup = btn.querySelector('.tip-popup');
  if(!popup) return;

  if(activeTipBtn && activeTipBtn !== btn) hideGlobalTip(activeTipBtn, false);

  tipEl.textContent = text;
  const rect = btn.getBoundingClientRect();
  const top = rect.bottom + 8;
  const left = Math.min(Math.max(rect.left + rect.width / 2, 12), window.innerWidth - 12);

  tipEl.style.top = `${top}px`;
  tipEl.style.left = `${left}px`;
  tipEl.style.transform = 'translate(-50%, 0)';
  tipEl.classList.add('visible');
  tipEl.setAttribute('aria-hidden', 'false');

  btn.setAttribute('aria-describedby', 'globalTip');
  updateTipAria(btn, true);
  activeTipBtn = btn;
}

function hideGlobalTip(btn = activeTipBtn, clearActive = true){
  const tipEl = document.getElementById('globalTip');
  if(!tipEl || !btn) return;
  tipEl.classList.remove('visible');
  tipEl.setAttribute('aria-hidden', 'true');
  btn.removeAttribute('aria-describedby');
  updateTipAria(btn, false);
  if(clearActive && activeTipBtn === btn) activeTipBtn = null;
}

function initGlobalTooltips(){
  const tipEl = document.getElementById('globalTip');
  if(!tipEl) return;
  tipEl.setAttribute('role', 'tooltip');

  document.querySelectorAll('.tip-btn').forEach(btn=>{
    if(btn.tabIndex < 0) btn.tabIndex = 0;
    btn.setAttribute('role', 'button');
    updateTipAria(btn, false);

    btn.addEventListener('mouseenter', ()=>showGlobalTip(btn));
    btn.addEventListener('focus', ()=>showGlobalTip(btn));

    btn.addEventListener('mouseleave', ()=>{
      if(activeTipBtn === btn) hideGlobalTip(btn);
    });
    btn.addEventListener('blur', ()=>{
      if(activeTipBtn === btn) hideGlobalTip(btn);
    });

    btn.addEventListener('click', e=>{
      e.preventDefault();
      if(activeTipBtn === btn) hideGlobalTip(btn);
      else showGlobalTip(btn);
    });

    btn.addEventListener('keydown', e=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        showGlobalTip(btn);
      }
      if(e.key === 'Escape'){
        e.preventDefault();
        hideGlobalTip(btn);
        btn.blur();
      }
    });
  });

  document.addEventListener('keydown', e=>{
    if(e.key === 'Escape' && activeTipBtn){
      hideGlobalTip(activeTipBtn);
    }
  });

  window.addEventListener('resize', ()=>{
    if(activeTipBtn) showGlobalTip(activeTipBtn);
  });

  window.addEventListener('scroll', ()=>{
    if(activeTipBtn) showGlobalTip(activeTipBtn);
  }, true);
}

// ── SIDEBAR TOGGLE ──
function toggleSidebar(){
  sidebarOpen = !sidebarOpen;
  document.body.classList.toggle('body-sidebar-collapsed', !sidebarOpen);
}

// ── MOBILE ──
function openMobileMenu(){
  document.getElementById('sidebar').classList.add('mobile-open');
  document.getElementById('mobileOverlay').classList.add('open');
}
function closeMobileMenu(){
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('mobileOverlay').classList.remove('open');
}


function initSummaryCompact(){
  summaryCompact = localStorage.getItem('rf-summary-compact') === '1';
  const compactToggle = document.getElementById('summaryCompactToggle');
  if(compactToggle) compactToggle.checked = summaryCompact;
}

function syncSummaryVisibilityState(){
  document.body.classList.remove('body-summary-open','body-summary-closing');
  document.querySelectorAll('[data-summary-toggle]').forEach(btn=>btn.classList.remove('active'));
  const panel = document.getElementById('summaryPanel');
  if(panel) panel.setAttribute('aria-hidden', summaryOpen ? 'false' : 'true');
}

function setSummaryCompact(nextState){
  summaryCompact = !!nextState;
  localStorage.setItem('rf-summary-compact', summaryCompact ? '1' : '0');
  const compactToggle = document.getElementById('summaryCompactToggle');
  if(compactToggle) compactToggle.checked = summaryCompact;
  buildSummaryPanel();
}

function toggleSummarySection(sectionId){
  const section = document.getElementById(sectionId);
  if(!section) return;
  section.classList.toggle('collapsed');
}

// ── SUMMARY PANEL ──
function toggleSummary(forceState){
  const nextState = typeof forceState === 'boolean' ? forceState : !summaryOpen;
  if(nextState === summaryOpen) return;

  if(summaryCloseTimer){
    clearTimeout(summaryCloseTimer);
    summaryCloseTimer = null;
  }

  if(nextState){
    summaryOpen = true;
    document.body.classList.remove('body-summary-closing');
    document.body.classList.add('body-summary-open');
    document.querySelectorAll('[data-summary-toggle]').forEach(btn=>btn.classList.add('active'));
    document.getElementById('summaryPanel')?.setAttribute('aria-hidden','false');
    buildSummaryPanel();
    return;
  }

  summaryOpen = false;
  document.body.classList.remove('body-summary-open');
  document.body.classList.add('body-summary-closing');
  document.querySelectorAll('[data-summary-toggle]').forEach(btn=>btn.classList.remove('active'));
  document.getElementById('summaryPanel')?.setAttribute('aria-hidden','true');
  summaryCloseTimer = setTimeout(()=>{
    document.body.classList.remove('body-summary-closing');
    summaryCloseTimer = null;
  }, 220);
}

// ── TAB SWITCHING ──
function switchTab(id, btn){
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(btn) btn.classList.add('active');
  currentTab = id;
  const idx = parseInt(id.replace('t','')) - 1;
  document.getElementById('footerStep').textContent = String(idx+1).padStart(2,'0');
  document.getElementById('footerStepName').textContent = STEP_NAMES[idx];
  document.querySelector('.tab-content').scrollTop = 0;
  closeMobileMenu();
  scheduleUpdate();
}
function goTab(id){
  const btn = document.querySelector(`[data-tab="${id}"]`);
  switchTab(id, btn);
}

function goToField(tabId, fieldId){
  if(!tabId) return;
  goTab(tabId);
  if(summaryOpen) toggleSummary(false);
  requestAnimationFrame(()=>{
    const field = fieldId ? document.getElementById(fieldId) : null;
    if(field){
      field.focus({preventScroll:false});
      if(typeof field.scrollIntoView === 'function') field.scrollIntoView({behavior:'smooth', block:'center'});
    }
  });
}

// ── CARD COLLAPSE ──
function toggleCard(head){
  const card = head.closest('.card');
  card.classList.toggle('collapsed');
}

// ── HF ZONE COLLAPSE ──
function toggleHF(head){
  const zone = head.closest('.hf-zone');
  zone.classList.toggle('hf-collapsed');
}

// ── SQL FIELDS ──
function toggleSqlFields(){
  const v = document.getElementById('sqlType').value;
  document.getElementById('sqlObjField').style.display = (v && v!=='query') ? '' : 'none';
  document.getElementById('sqlInlineField').style.display = v==='query' ? '' : 'none';
}

// ── HEADER MODE ──
const HM_HINTS = {
  static:'Statyczny nagłówek to stały tekst w CR Designer — nie zmienia się w runtime.',
  param:'Nagłówek pobierany z parametru CR ({?X}) — można zmienić z C# przed generowaniem.',
  formula:'Nagłówek generowany przez CR Formula ({@X}) — może zależeć od parametrów, języka, dat.',
  mixed:'Każda kolumna ma własny tryb nagłówka — konfigurowane indywidualnie per wiersz.'
};
function setHM(m){ document.getElementById('hmHint').innerHTML = `<i class="bi bi-info-circle"></i>${HM_HINTS[m]}`; }

// ── REMOVE ROW ──
function removeRow(btn){
  const tr = btn.closest('tr'), tb = tr.closest('tbody');
  tr.remove(); renumber(tb);
  scheduleUpdate();
}
function renumber(tb){ if(!tb)return; Array.from(tb.rows).forEach((r,i)=>{ const c=r.querySelector('.row-num'); if(c) c.textContent=i+1; }); }

function moveRow(btn, direction){
  const tr = btn.closest('tr');
  const tb = tr?.closest('tbody');
  if(!tr || !tb) return;
  const target = direction < 0 ? tr.previousElementSibling : tr.nextElementSibling;
  if(!target) return;
  if(direction < 0){
    tb.insertBefore(tr, target);
  }else{
    tb.insertBefore(target, tr);
  }
  renumber(tb);
  scheduleUpdate();
}

function moveColRow(btn, direction){
  moveRow(btn, direction);
}

// ── ADD COLUMN ──
function colRowHtml(n, type=''){
  return `<tr>
    <td><span class="drag-handle"><i class="bi bi-grip-vertical"></i></span></td>
    <td>
      <div class="row-move">
        <button class="btn-move" type="button" onclick="moveColRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button>
        <button class="btn-move" type="button" onclick="moveColRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button>
      </div>
    </td>
    <td class="row-num">${n}</td>
    <td><input type="text" class="mono" placeholder="${type==='formula'?'{@FormulaNazwa}':type==='rt'?'#{RunningTotal}':'pole_db'}"/></td>
    <td><input type="text" placeholder="Nagłówek"/></td>
    <td><select><option>—</option><option${type==='formula'?' selected':''}>Formula</option><option>String</option><option>Number</option><option>Currency</option><option>Date</option><option>DateTime</option><option>Boolean</option><option>Percent</option></select></td>
    <td><input type="text" placeholder="format"/></td>
    <td style="text-align:center"><input type="checkbox" checked/></td>
    <td style="text-align:center"><input type="checkbox"/></td>
    <td><select><option>L</option><option>Ś</option><option>P</option></select></td>
    <td><select><option>Brak</option><option>Kolor</option><option>Tło</option><option>Bold</option><option>Wiele</option></select></td>
    <td><button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button></td>
  </tr>`;
}
function addColRow(){ const tb=document.getElementById('colBody'); tb.insertAdjacentHTML('beforeend', colRowHtml(tb.rows.length+1)); scheduleUpdate(); }
function addFormulaCol(){ const tb=document.getElementById('colBody'); tb.insertAdjacentHTML('beforeend', colRowHtml(tb.rows.length+1,'formula')); scheduleUpdate(); }
function addRunningTotal(){ const tb=document.getElementById('colBody'); tb.insertAdjacentHTML('beforeend', colRowHtml(tb.rows.length+1,'rt')); scheduleUpdate(); }

// ── ADD CF ROW ──
function addCFRow(){
  const tb=document.getElementById('cfBody'); const n=tb.rows.length+1;
  tb.insertAdjacentHTML('beforeend',`<tr><td class="row-num">${n}</td><td><input type="text" class="mono" placeholder="kolumna"/></td><td><input type="text" class="mono" placeholder="{pole} < 0"/></td><td><select><option>Kolor tekstu</option><option>Kolor tła</option><option>Oba</option><option>Bold</option></select></td><td><input type="color" value="#dc2626"/></td><td><input type="color" value="#fee2e2"/></td><td><select><option>Normal</option><option>Bold</option><option>Italic</option></select></td><td><input type="text" placeholder="Opis"/></td><td><div class="row-actions"><div class="row-move"><button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button><button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button></div><button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button></div></td></tr>`);
  scheduleUpdate();
}

// ── ADD PARAM ROW ──
function addParamRow(){
  const tb=document.getElementById('paramBody'); const n=tb.rows.length+1;
  tb.insertAdjacentHTML('beforeend',`<tr><td class="row-num">${n}</td><td><input type="text" class="mono" placeholder="NazwaParam"/></td><td><select><option>—</option><option>String</option><option>Number</option><option>Date</option><option>DateTime</option><option>Boolean</option></select></td><td><input type="text" placeholder="domyślna"/></td><td style="text-align:center"><input type="checkbox"/></td><td style="text-align:center"><input type="checkbox"/></td><td><select><option>DatePicker</option><option>TextBox</option><option>Dropdown</option><option>MultiSelect</option><option>Ukryta</option></select></td><td><input type="text" class="mono" placeholder="SELECT..."/></td><td><input type="text" placeholder="Opis"/></td><td><div class="row-actions"><div class="row-move"><button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button><button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button></div><button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button></div></td></tr>`); scheduleUpdate();
}

// ── FILTER GROUP ──
let fgc = 0;
function addFilterGroup(){
  fgc++; const div=document.createElement('div'); div.className='cond-group';
  div.innerHTML=`<div class="cond-group-bar"><span style="font-size:11px;font-weight:800;color:var(--muted);font-family:'JetBrains Mono',monospace">GRUPA ${fgc}</span><span style="font-size:12px;color:var(--muted)">Wewnątrz:</span><select class="logic-sel"><option>AND</option><option>OR</option></select><span style="margin-left:auto;font-size:12px;color:var(--muted)">Z następną:</span><select class="logic-sel"><option>AND</option><option>OR</option></select><button class="btn-danger-sm ms-2" onclick="removeFilterGroup(this)"><i class="bi bi-x"></i></button></div><div style="padding:8px"><div class="dt-wrap"><table class="dt"><thead><tr><th>#</th><th>Pole</th><th>Poziom</th><th>Operator</th><th>Wartość</th><th>Typ wartości</th><th>NOT</th><th>Opis</th><th></th></tr></thead><tbody class="filter-rows"><tr><td class="row-num">1</td><td><input type="text" class="mono" placeholder="pole"/></td><td><select><option>SQL WHERE</option><option>CR Record</option><option>CR Group</option></select></td><td><select><option>= (równa się)</option><option>!=</option><option>&gt;</option><option>&lt;</option><option>BETWEEN</option><option>IN</option><option>LIKE</option><option>IS NULL</option><option>IS NOT NULL</option></select></td><td><input type="text" placeholder="wartość"/></td><td><select><option>Stała</option><option>Param CR</option><option>Formuła CR</option><option>Inne pole</option></select></td><td style="text-align:center"><input type="checkbox" style="accent-color:var(--r)"/></td><td><input type="text" placeholder="Opis"/></td><td><button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button></td></tr></tbody></table></div><button class="btn-add mt-2" style="font-size:12px;padding:5px 12px" onclick="addFilterRow(this)"><i class="bi bi-plus-lg"></i>Dodaj warunek</button></div>`;
  document.getElementById('filterGroups').appendChild(div);
  scheduleUpdate();
}
function removeFilterGroup(btn){
  btn.closest('.cond-group')?.remove();
  scheduleUpdate();
}
function addFilterRow(btn){
  const tb=btn.closest('.cond-group').querySelector('.filter-rows'); const n=tb.rows.length+1;
  tb.insertAdjacentHTML('beforeend',`<tr><td class="row-num">${n}</td><td><input type="text" class="mono" placeholder="pole"/></td><td><select><option>SQL WHERE</option><option>CR Record</option><option>CR Group</option></select></td><td><select><option>= (równa się)</option><option>!=</option><option>&gt;</option><option>&lt;</option><option>BETWEEN</option><option>IN</option><option>LIKE</option><option>IS NULL</option><option>IS NOT NULL</option></select></td><td><input type="text" placeholder="wartość"/></td><td><select><option>Stała</option><option>Param CR</option><option>Formuła CR</option><option>Inne pole</option></select></td><td style="text-align:center"><input type="checkbox" style="accent-color:var(--r)"/></td><td><input type="text" placeholder="Opis"/></td><td><div class="row-actions"><div class="row-move"><button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button><button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button></div><button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button></div></td></tr>`);
  scheduleUpdate();
}

// ── ADD GROUP ROW ──
function addGroupRow(){
  const tb=document.getElementById('groupBody'); const n=tb.rows.length+1;
  tb.insertAdjacentHTML('beforeend',`<tr><td class="row-num">${n}</td><td><input type="text" class="mono" placeholder="pole"/></td><td><select><option>ASC</option><option>DESC</option><option>Custom</option></select></td><td><select><option>Brak</option><option>SUM</option><option>COUNT</option><option>AVG</option><option>MIN</option><option>MAX</option></select></td><td><input type="text" class="mono" placeholder="pole_kwota"/></td><td style="text-align:center"><input type="checkbox"/></td><td style="text-align:center"><input type="checkbox"/></td><td><input type="text" placeholder="Nagłówek"/></td><td><input type="text" placeholder="Stopka"/></td><td><div class="row-actions"><div class="row-move"><button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button><button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button></div><button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button></div></td></tr>`);
  scheduleUpdate();
}

// ── SUBREPORTS ──
let src = 0;
function addSubreport(){
  src++; const id=`sr${src}`;
  const div=document.createElement('div'); div.className='sr-card'; div.id=id;
  div.innerHTML=`<div class="sr-head"><span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted)">SR-${String(src).padStart(2,'0')}</span><span style="font-weight:800;flex:1;font-size:13px" id="${id}-label">Nowy podraport</span><span class="sr-pill sr-inline">Inline</span><button class="btn-rm ms-2" onclick="this.closest('.sr-card').remove()"><i class="bi bi-trash3"></i></button></div><div class="sr-tabs"><button class="sr-tab active" onclick="srTab(this,'${id}-a')">Identyfikacja</button><button class="sr-tab" onclick="srTab(this,'${id}-b')">Źródło danych</button><button class="sr-tab" onclick="srTab(this,'${id}-c')">Powiązanie</button><button class="sr-tab" onclick="srTab(this,'${id}-d')">Kolumny</button><button class="sr-tab" onclick="srTab(this,'${id}-e')">Wydajność</button></div><div class="sr-pane active" id="${id}-a"><div class="form-row cols-3"><div class="field"><label class="field-label">Nazwa .rpt</label><input type="text" class="fc mono" placeholder="SR_Nazwa.rpt" oninput="document.getElementById('${id}-label').textContent=this.value||'Nowy podraport'"/></div><div class="field"><label class="field-label">Typ</label><select class="fs"><option>Inline</option><option>On-demand</option><option>Linked Embedded</option></select></div><div class="field"><label class="field-label">Sekcja CR</label><select class="fs"><option>Report Header</option><option>Report Footer</option><option>Group Header</option><option>Group Footer</option><option>Details</option></select></div></div><div class="field mt-2"><label class="field-label">Opis biznesowy</label><textarea class="fc" rows="2" placeholder="Co prezentuje ten podraport?"></textarea></div></div><div class="sr-pane" id="${id}-b"><div class="form-row cols-3"><div class="field"><label class="field-label">Typ źródła</label><select class="fs"><option>VIEW</option><option>SP</option><option>Zapytanie SQL</option></select></div><div class="field"><label class="field-label">Obiekt SQL</label><input type="text" class="fc mono" placeholder="dbo.v_SR_Dane"/></div><div class="field"><label class="field-label">Parametry SR</label><input type="text" class="fc" placeholder="LinkID:Number"/></div></div><div class="field mt-2"><label class="field-label">Zapytanie SQL</label><textarea class="fc mono" rows="3" placeholder="SELECT ... WHERE id = {?LinkID}"></textarea></div></div><div class="sr-pane" id="${id}-c"><div class="info-alert mb-3"><i class="bi bi-info-circle"></i>Powiązanie = przekazywanie wartości z raportu głównego do parametrów SR przez SubreportLinks.</div><div class="dt-wrap"><table class="dt"><thead><tr><th>#</th><th>Pole raportu głównego</th><th>→</th><th>Parametr SR ({?X})</th><th>Konwersja</th><th></th></tr></thead><tbody id="${id}-links"><tr><td class="row-num">1</td><td><input type="text" class="mono" placeholder="{Orders.ID}"/></td><td style="text-align:center;color:var(--g);font-size:16px">→</td><td><input type="text" class="mono" placeholder="{?LinkID}"/></td><td><select><option>Brak</option><option>ToText</option><option>ToNumber</option><option>CDate</option></select></td><td><div class="row-actions"><div class="row-move"><button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button><button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button></div><button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button></div></td></tr></tbody></table></div><button class="btn-add mt-2" onclick="addSrLink('${id}-links')"><i class="bi bi-plus-lg"></i>Dodaj powiązanie</button></div><div class="sr-pane" id="${id}-d"><div class="dt-wrap"><table class="dt"><thead><tr><th>#</th><th>Pole</th><th>Nagłówek</th><th>Typ</th><th>Format</th><th>Widoczna</th><th></th></tr></thead><tbody id="${id}-cols"><tr><td class="row-num">1</td><td><input type="text" class="mono" placeholder="pole"/></td><td><input type="text" placeholder="Nagłówek"/></td><td><select><option>String</option><option>Number</option><option>Currency</option><option>Date</option></select></td><td><input type="text" placeholder="format"/></td><td style="text-align:center"><input type="checkbox" checked/></td><td><div class="row-actions"><div class="row-move"><button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button><button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button></div><button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button></div></td></tr></tbody></table></div><button class="btn-add mt-2" onclick="addSrCol('${id}-cols')"><i class="bi bi-plus-lg"></i>Dodaj kolumnę</button></div><div class="sr-pane" id="${id}-e"><div class="form-row cols-3"><div class="field"><label class="field-label">Wywołania</label><select class="fs"><option>1 raz</option><option>Per grupę</option><option>Per wiersz</option><option>On-demand</option></select></div><div class="field"><label class="field-label">Szac. wierszy SR</label><select class="fs"><option>Małe (&lt;50)</option><option>Średnie (50-500)</option><option>Duże (500-5000)</option><option>Bardzo duże (&gt;5000)</option></select></div><div class="field"><label class="field-label">Ryzyko wydajnościowe</label><select class="fs"><option>Niskie</option><option>Średnie</option><option>Wysokie</option><option>Krytyczne</option></select></div></div><div class="field mt-2"><label class="field-label">Uwagi optymalizacyjne</label><input type="text" class="fc" placeholder="np. Rozważ JOIN zamiast podraportu..."/></div></div>`;
  document.getElementById('subreportList').appendChild(div);
  scheduleUpdate();
}
function srTab(btn, panId){
  const sc=btn.closest('.sr-card');
  sc.querySelectorAll('.sr-tab').forEach(t=>t.classList.remove('active'));
  sc.querySelectorAll('.sr-pane').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(panId).classList.add('active');
}
function addSrLink(id){ const tb=document.getElementById(id); tb.insertAdjacentHTML('beforeend',`<tr><td class="row-num">${tb.rows.length+1}</td><td><input type="text" class="mono" placeholder="pole główne"/></td><td style="text-align:center;color:var(--g);font-size:16px">→</td><td><input type="text" class="mono" placeholder="{?Param}"/></td><td><select><option>Brak</option><option>ToText</option><option>ToNumber</option><option>CDate</option></select></td><td><div class="row-actions"><div class="row-move"><button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button><button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button></div><button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button></div></td></tr>`); scheduleUpdate(); }
function addSrCol(id){ const tb=document.getElementById(id); tb.insertAdjacentHTML('beforeend',`<tr><td class="row-num">${tb.rows.length+1}</td><td><input type="text" class="mono" placeholder="pole"/></td><td><input type="text" placeholder="Nagłówek"/></td><td><select><option>String</option><option>Number</option><option>Currency</option><option>Date</option></select></td><td><input type="text" placeholder="format"/></td><td style="text-align:center"><input type="checkbox" checked/></td><td><div class="row-actions"><div class="row-move"><button class="btn-move" type="button" onclick="moveRow(this,-1)" title="Przesuń w górę"><i class="bi bi-chevron-up"></i></button><button class="btn-move" type="button" onclick="moveRow(this,1)" title="Przesuń w dół"><i class="bi bi-chevron-down"></i></button></div><button class="btn-rm" onclick="removeRow(this)"><i class="bi bi-trash3"></i></button></div></td></tr>`); scheduleUpdate(); }

// ── FORMAT CARD ──
function toggleFmt(head){
  const body=head.nextElementSibling;
  body.classList.toggle('open');
  head.querySelector('.fmt-chevron').style.transform=body.classList.contains('open')?'':'rotate(-90deg)';
}
function addFmtCard(){
  const fmt=prompt('Nazwa formatu:'); if(!fmt) return;
  document.getElementById('fmtContainer').insertAdjacentHTML('beforeend',`<div class="fmt-card mt-2"><div class="fmt-head" onclick="toggleFmt(this)"><div class="fmt-ico" style="background:var(--a-l);color:var(--a)"><i class="bi bi-file-earmark"></i></div><span class="fmt-name">${fmt}</span><div style="margin-left:auto" onclick="event.stopPropagation()"><label class="toggle-sw" style="width:32px;height:18px"><input class="fmt-cb" type="checkbox" checked onchange="onFieldChange(this)"><div class="toggle-track"><div class="toggle-thumb" style="width:12px;height:12px;top:3px;left:3px"></div></div></label></div><i class="bi bi-chevron-down fmt-chevron ms-2"></i></div><div class="fmt-body open"><div class="form-row cols-2"><div class="field"><label class="field-label">Typ eksportu CR</label><input type="text" class="fc mono" placeholder="ExportFormatType.HTML40"/></div><div class="field"><label class="field-label">Wzorzec nazwy</label><input type="text" class="fc mono" placeholder="Raport.html"/></div></div><div class="field mt-2"><label class="field-label">Wytyczne dewelopera</label><textarea class="fc" rows="2" placeholder="Opisz wymagania..."></textarea></div></div></div>`);
}

// ── TOKENS ──
let lastFC = null;
document.addEventListener('focusin', e=>{ if(e.target.matches('input[type=text],input[type=date],textarea')) lastFC=e.target; });
function insertToken(t){ if(lastFC){ const s=lastFC.selectionStart,e=lastFC.selectionEnd,v=lastFC.value; lastFC.value=v.slice(0,s)+t+v.slice(e); lastFC.selectionStart=lastFC.selectionEnd=s+t.length; lastFC.focus(); showToast(`Token ${t} wstawiony`,'success'); } else { showToast('Kliknij najpierw w pole tekstowe.','warning'); } }

// ── EMPTY STATE PREVIEW ──
function updateEmptyPreview(){
  const msg=document.getElementById('emptyMsg').value||'Brak danych dla wybranych kryteriów.';
  const hint=document.getElementById('emptyHint').value||'Zmień filtry i spróbuj ponownie.';
  const icoRaw=document.getElementById('emptyIcon').value||'bi-inbox';
  const ico = /^bi-[a-z0-9-]+$/i.test(icoRaw) ? icoRaw : 'bi-inbox';
  const preview = document.getElementById('emptyPreview');
  preview.innerHTML = '';

  const iconWrap = document.createElement('span');
  iconWrap.className = 'es-icon';
  const icon = document.createElement('i');
  icon.className = `bi ${ico}`;
  iconWrap.appendChild(icon);

  const title = document.createElement('div');
  title.className = 'es-title';
  title.textContent = msg;

  const sub = document.createElement('div');
  sub.className = 'es-sub';
  sub.textContent = hint;

  preview.append(iconWrap, title, sub);
}

// ── FIELD CHANGE → UPDATE INDICATORS ──
function onFieldChange(el){
  if(el && el.value && el.classList.contains('fc')){
    el.classList.add('filled');
  }
  scheduleUpdate();
}

let updateTimer = null;
function scheduleUpdate(){ clearTimeout(updateTimer); updateTimer = setTimeout(updateAll, 150); }

function escapeHtml(value){
  return String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}


const JSON_SNAPSHOT_VERSION = '1.0.0';

function triggerJsonLoad(){
  const input = document.getElementById('jsonImportInput');
  if(!input) return;
  input.value = '';
  input.click();
}

function hasMeaningfulData(snapshot){
  const fields = snapshot?.fields || {};
  const hasFilledField = Object.values(fields).some(value=>{
    if(typeof value === 'boolean') return value;
    return String(value ?? '').trim().length > 0 && String(value).trim() !== '—';
  });

  const dynamic = snapshot?.dynamic || {};
  const hasDynamic = ['filters','subreports','customFormats']
    .some(key=>Array.isArray(dynamic[key]) && dynamic[key].length > 0);

  return hasFilledField || hasDynamic;
}

function startNewForm(){
  const snapshot = getFormSnapshot();
  const hasAnyData = hasMeaningfulData(snapshot);
  if(hasAnyData && !window.confirm('Czy na pewno utworzyć nowy formularz? Niezapisane dane zostaną utracone.')) return;
  window.location.reload();
}

function getInputKey(el){
  if(el.id) return `id:${el.id}`;
  if(el.name) return `name:${el.name}`;
  return null;
}

function getFieldValue(el){
  if(el.type === 'checkbox' || el.type === 'radio') return !!el.checked;
  return el.value ?? '';
}

function collectNodeValues(root){
  const out = {};
  if(!root) return out;
  root.querySelectorAll('input, textarea, select').forEach(el=>{
    const key = getInputKey(el);
    if(!key || el.type === 'file') return;
    out[key] = getFieldValue(el);
  });
  return out;
}

function collectSubreportsSnapshot(){
  return Array.from(document.querySelectorAll('#subContainer .sr-card')).map(card=>({
    html: card.outerHTML
  }));
}

function collectFilterGroupsSnapshot(){
  return Array.from(document.querySelectorAll('#filterGroups .fgroup')).map(group=>({
    html: group.outerHTML
  }));
}

function collectCustomFormatsSnapshot(){
  return Array.from(document.querySelectorAll('#fmtContainer .fmt-card')).map(card=>({
    html: card.outerHTML
  }));
}

function getFormSnapshot(){
  return {
    app: 'ReportForge',
    schemaVersion: JSON_SNAPSHOT_VERSION,
    exportedAt: new Date().toISOString(),
    uiState: {
      currentTab,
      theme: localStorage.getItem('rf-theme') || 'light',
      summaryCompact: localStorage.getItem('rf-summary-compact') === '1'
    },
    fields: collectNodeValues(document),
    dynamic: {
      filters: collectFilterGroupsSnapshot(),
      subreports: collectSubreportsSnapshot(),
      customFormats: collectCustomFormatsSnapshot()
    }
  };
}

function getFileBaseName(){
  const reportName = (document.getElementById('rName')?.value || 'reportforge-form').trim();
  return reportName
    .toLowerCase()
    .replace(/[^a-z0-9_-]+/g, '-')
    .replace(/-{2,}/g, '-')
    .replace(/^-|-$/g, '') || 'reportforge-form';
}

function saveFormToJson(){
  const payload = getFormSnapshot();
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${getFileBaseName()}-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast('Zapisano formularz do JSON.','success');
}

function applyValueToElement(el, value){
  if(!el) return;
  if(el.type === 'checkbox' || el.type === 'radio'){
    el.checked = !!value;
  }else{
    el.value = value ?? '';
  }
}

function applyFieldsFromSnapshot(fields){
  if(!fields || typeof fields !== 'object') return 0;
  let loaded = 0;
  Object.entries(fields).forEach(([key, value])=>{
    const [kind, rawSelector] = key.split(':');
    if(!kind || !rawSelector) return;
    let element = null;
    if(kind === 'id'){
      element = document.getElementById(rawSelector);
    }else if(kind === 'name'){
      element = document.querySelector(`[name="${CSS.escape(rawSelector)}"]`);
    }
    if(!element) return;
    applyValueToElement(element, value);
    loaded++;
  });
  return loaded;
}

function restoreDynamicCards(selector, items){
  if(!Array.isArray(items)) return {loaded:0, total:0};
  const container = document.querySelector(selector);
  if(!container) return {loaded:0, total:items.length};
  container.innerHTML = '';
  let loaded = 0;
  items.forEach(item=>{
    if(!item || typeof item.html !== 'string') return;
    container.insertAdjacentHTML('beforeend', item.html);
    loaded++;
  });
  return {loaded, total:items.length};
}

function applySnapshot(snapshot){
  if(!snapshot || typeof snapshot !== 'object') throw new Error('Nieprawidłowa struktura JSON.');

  const loadedFields = applyFieldsFromSnapshot(snapshot.fields);
  const totalFields = snapshot.fields && typeof snapshot.fields === 'object' ? Object.keys(snapshot.fields).length : 0;

  const dynamic = snapshot.dynamic || {};
  const filtersResult = restoreDynamicCards('#filterGroups', dynamic.filters);
  const subreportsResult = restoreDynamicCards('#subContainer', dynamic.subreports);
  const formatsResult = restoreDynamicCards('#fmtContainer', dynamic.customFormats);

  if(!document.querySelector('#filterGroups .fgroup')) addFilterGroup();

  document.querySelectorAll('tbody').forEach(tb=>renumber(tb));

  if(snapshot.uiState?.theme) setTheme(snapshot.uiState.theme);
  if(typeof snapshot.uiState?.summaryCompact === 'boolean') setSummaryCompact(snapshot.uiState.summaryCompact);

  const tab = snapshot.uiState?.currentTab;
  if(tab && document.getElementById(tab)) goTab(tab);

  scheduleUpdate();

  const dynamicLoaded = filtersResult.loaded + subreportsResult.loaded + formatsResult.loaded;
  const dynamicTotal = filtersResult.total + subreportsResult.total + formatsResult.total;
  const missingFields = Math.max(totalFields - loadedFields, 0);
  const missingDynamic = Math.max(dynamicTotal - dynamicLoaded, 0);
  const missingTotal = missingFields + missingDynamic;

  if(missingTotal > 0){
    showToast(`Wczytano częściowo JSON (pominięte elementy: ${missingTotal}).`,'warning');
  }else{
    showToast('Wczytano formularz z JSON.','success');
  }
}

function loadFormFromJsonFile(event){
  const file = event?.target?.files?.[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const parsed = JSON.parse(e.target?.result || '{}');
      applySnapshot(parsed);
    }catch(_err){
      showToast('Nie udało się odczytać pliku JSON.','warning');
    }
  };
  reader.onerror = ()=>showToast('Błąd odczytu pliku.','warning');
  reader.readAsText(file, 'utf-8');
}

// ── COMPUTE TAB COMPLETION ──
function countFilledInputs(pane){
  if(!pane) return 0;
  const allInputs = pane.querySelectorAll('input[type=text]:not([type=hidden]),textarea,select');
  let count = 0;
  allInputs.forEach(el=>{
    const v = (el.value || '').trim();
    if(v && v !== '—' && v !== '— wybierz —' && v !== '— wybierz typ —') count++;
  });
  return count;
}

function completionFromRequired(tab, pane){
  const required = tab.required;
  let filled = 0, total = required.length;

  required.forEach(id=>{
    const el = document.getElementById(id);
    if(el && el.value.trim().length > 0) filled++;
  });

  const anyFilled = countFilledInputs(pane);

  if(total === 0){
    if(anyFilled === 0) return {status:'none', progress:0};
    return {status:'partial', progress:50};
  }
  if(filled === 0 && anyFilled === 0) return {status:'none', progress:0};
  if(filled < total) return {status:'partial', progress:Math.round((filled/total)*100)};
  return {status:'complete', progress:100};
}

function completionFromStructure({ready, touched}){
  if(ready) return {status:'complete', progress:100};
  if(touched) return {status:'partial', progress:50};
  return {status:'none', progress:0};
}

const COMPLETION_CHECKS = {
  required: completionFromRequired,
  columns: (tab, pane)=> completionFromStructure({
    ready: document.getElementById('colBody').rows.length >= 1,
    touched: countFilledInputs(pane) > 0
  }),
  params: (tab, pane)=> completionFromStructure({
    ready: document.getElementById('paramBody').rows.length >= 1,
    touched: countFilledInputs(pane) > 0
  }),
  filters: (tab, pane)=> {
    const groups = document.querySelectorAll('#filterGroups .cond-group').length;
    const filledFilterValues = Array.from(document.querySelectorAll('#filterGroups .filter-rows input[type=text]')).filter(el=>(el.value||'').trim().length>0).length;
    return completionFromStructure({
      ready: groups >= 1 && filledFilterValues >= 1,
      touched: countFilledInputs(pane) > 0 || groups > 0
    });
  },
  groups: (tab, pane)=> completionFromStructure({
    ready: document.getElementById('groupBody').rows.length >= 1,
    touched: countFilledInputs(pane) > 0
  }),
  subreports: (tab, pane)=> completionFromStructure({
    ready: document.querySelectorAll('.sr-card').length >= 1,
    touched: countFilledInputs(pane) > 0
  }),
  exports: (tab, pane)=> completionFromStructure({
    ready: document.querySelectorAll('.fmt-cb:checked').length >= 1,
    touched: countFilledInputs(pane) > 0
  })
};

function computeTabCompletion(tab){
  const pane = document.getElementById(tab.id);
  const checker = tab.completionCheck;
  if(typeof checker === 'function') return checker(tab, pane);
  if(typeof checker === 'string' && COMPLETION_CHECKS[checker]) return COMPLETION_CHECKS[checker](tab, pane);
  return completionFromRequired(tab, pane);
}

function computeTabStatus(tab){
  return computeTabCompletion(tab).status;
}

function updateAll(){
  let progressSum = 0;
  const tabData = [];
  TABS.forEach(tab=>{
    const completion = computeTabCompletion(tab);
    const status = completion.status;
    const dot = document.getElementById(`ts-${tab.id}`);
    if(dot){
      dot.className = `tab-status ${status}`;
    }
    tabData.push({...tab, ...completion});
    progressSum += completion.progress;
  });

  const pct = Math.round(progressSum/TABS.length);
  document.getElementById('globalProgressFill').style.width = pct+'%';
  document.getElementById('progressLabel').textContent = pct+'% gotowe';

  // Score circle
  const circle = document.getElementById('scoreCircle');
  const circ = 239;
  circle.style.strokeDashoffset = circ - (circ * pct/100);
  document.getElementById('scorePct').textContent = pct+'%';
  const stxt = document.getElementById('scoreStatusTxt');
  if(pct===0){ stxt.textContent='Uzupełnij pola aby śledzić postęp'; stxt.style.color='var(--muted)'; }
  else if(pct<50){ stxt.textContent='Dobry początek — kontynuuj!'; stxt.style.color='var(--y)'; }
  else if(pct<100){ stxt.textContent='Prawie gotowe — świetna robota!'; stxt.style.color='var(--a)'; }
  else { stxt.textContent='Definicja kompletna! 🎉'; stxt.style.color='var(--g)'; }

  const validationErrors = getValidationErrors();
  updateQuickFixCta(getPrioritySuggestions(validationErrors)[0] || null);

  // Update summary panel if open
  if(summaryOpen) buildSummaryPanel(tabData, pct);
}

// ── BUILD SUMMARY PANEL ──
function buildSummaryPanel(tabData, pct){
  if(!tabData){
    tabData = TABS.map(t=>({...t, ...computeTabCompletion(t)}));
    pct = Math.round(tabData.reduce((acc,t)=>acc+t.progress,0)/TABS.length);
  }

  const compactClass = summaryCompact ? 'sum-tab-meta compact-hidden' : 'sum-tab-meta';

  // Tab list
  const tl = document.getElementById('sumTabList');
  tl.innerHTML = tabData.map((t,i)=>{
    const icoClass = t.status==='complete'?'sum-ico-g':t.status==='partial'?'sum-ico-y':'sum-ico-n';
    const icoI = t.status==='complete'?'bi-check':'bi-dash';
    const pctTxt = `${t.progress}%`;
    const statusText = t.status==='complete'?'Kompletna':t.status==='partial'?'W trakcie':'Do uzupełnienia';
    const reqInfo = t.required?.length ? `Wymagane: ${t.required.length}` : 'Brak pól wymaganych';
    return `<div class="sum-tab-row" onclick="goTab('${t.id}');toggleSummary(false)">
      <div class="tab-ico sum-tab-ico ${icoClass}"><i class="bi ${icoI}"></i></div>
      <div class="sum-tab-name">${t.name}<span class="${compactClass}">${statusText} · ${reqInfo}</span></div>
      <span class="sum-tab-pct">${pctTxt}</span>
    </div>`;
  }).join('');

  // Details
  const rName = (document.getElementById('rName')||{}).value||'';
  const rTitle = (document.getElementById('rTitle')||{}).value||'';
  const rStatus = (document.getElementById('rStatus')||{}).value||'Szkic';
  const sqlType = (document.getElementById('sqlType')||{}).value||'';
  const cols = document.getElementById('colBody').rows.length;
  const params = document.getElementById('paramBody').rows.length;
  const groups = document.getElementById('groupBody').rows.length;
  const srs = document.querySelectorAll('.sr-card').length;
  const activeFmts = document.querySelectorAll('.fmt-cb:checked').length;

  const sqlLabels={view:'Widok (VIEW)',proc:'SP',fn:'TVF',query:'SQL inline','':'—'};
  const safeRName = escapeHtml(rName || '(nie podano)');
  const safeRTitle = escapeHtml(rTitle || '(nie podano)');
  const safeRStatus = escapeHtml(rStatus);
  const safeSqlLabel = escapeHtml(sqlLabels[sqlType] || '—');

  if(summaryCompact){
    document.getElementById('sumDetails').innerHTML = `
      <div class="sum-detail"><div class="sum-detail-label">Status · Postęp</div><div class="sum-detail-val"><span class="sum-badge blue">${safeRStatus}</span> <span class="sum-badge green">${pct}%</span></div></div>
      <div class="sum-detail"><div class="sum-detail-label">Najważniejsze liczniki</div><div class="sum-detail-val">Kolumny: ${cols} · Parametry: ${params} · Grupy: ${groups} · SR: ${srs}</div></div>
      <div class="sum-detail"><div class="sum-detail-label">Źródło · Eksport</div><div class="sum-detail-val"><span class="sum-badge ${sqlType?'green':'yellow'}">${safeSqlLabel}</span> <span class="sum-badge blue">Formaty: ${activeFmts}</span></div></div>
    `;
  } else {
    document.getElementById('sumDetails').innerHTML = `
      <div class="sum-detail"><div class="sum-detail-label">Nazwa raportu</div><div class="sum-detail-val ${!rName?'empty':''}">${safeRName}</div></div>
      <div class="sum-detail"><div class="sum-detail-label">Tytuł wyświetlany</div><div class="sum-detail-val ${!rTitle?'empty':''}">${safeRTitle}</div></div>
      <div class="sum-detail"><div class="sum-detail-label">Status · Źródło SQL</div><div class="sum-detail-val"><span class="sum-badge blue">${safeRStatus}</span> <span class="sum-badge ${sqlType?'green':'yellow'}">${safeSqlLabel}</span></div></div>
      <div class="sum-detail"><div class="sum-detail-label">Kolumny · Parametry · Grupy · SR</div><div class="sum-detail-val">${cols} · ${params} · ${groups} · ${srs}</div></div>
      <div class="sum-detail"><div class="sum-detail-label">Aktywne formaty eksportu</div><div class="sum-detail-val">${activeFmts} aktywnych</div></div>
    `;
  }

  // Alerts
  const validationErrors = getValidationErrors();
  renderValidationSummary(validationErrors);
}

// ── VALIDATION ──
const VALIDATION_CONFIG = [
  {id:'rName', tab:'t1', label:'Nazwa raportu'},
  {id:'rTitle', tab:'t1', label:'Tytuł wyświetlany'},
  {id:'rDesc', tab:'t1', label:'Opis / cel raportu'},
  {id:'sqlType', tab:'t2', label:'Typ źródła SQL'},
  {id:'defaultExportFormat', tab:'t10', label:'Domyślny format eksportu'}
];

function clearValidationErrors(){
  document.querySelectorAll('.validation-error').forEach(el=>el.classList.remove('validation-error'));
  document.querySelectorAll('.field-validation-message').forEach(el=>{
    el.textContent = '';
    el.classList.remove('visible');
  });
}

function showFieldError(fieldId, message){
  const el = document.getElementById(fieldId);
  if(!el) return;
  el.classList.add('validation-error');
  const fieldWrap = el.closest('.field') || el.parentElement;
  if(!fieldWrap) return;
  let msgEl = fieldWrap.querySelector('.field-validation-message');
  if(!msgEl){
    msgEl = document.createElement('div');
    msgEl.className = 'field-validation-message';
    fieldWrap.appendChild(msgEl);
  }
  msgEl.textContent = message;
  msgEl.classList.add('visible');
}

function getValidationErrors(){
  const errors = [];
  VALIDATION_CONFIG.forEach(cfg=>{
    const el = document.getElementById(cfg.id);
    if(!el) return;
    if(!el.checkValidity()){
      let message = el.validationMessage || `Pole "${cfg.label}" jest nieprawidłowe.`;
      if(cfg.id === 'rName'){
        if(el.validity.valueMissing) message = 'Nazwa raportu jest wymagana.';
        else if(el.validity.tooShort) message = 'Nazwa raportu musi mieć min. 3 znaki.';
        else if(el.validity.patternMismatch) message = 'Nazwa raportu może zawierać tylko litery, cyfry i podkreślenia (bez spacji).';
      }
      if(cfg.id === 'rTitle' && el.validity.valueMissing) message = 'Tytuł wyświetlany jest wymagany.';
      if(cfg.id === 'rDesc'){
        if(el.validity.valueMissing) message = 'Opis / cel raportu jest wymagany.';
        else if(el.validity.tooShort) message = 'Opis raportu musi mieć co najmniej 20 znaków.';
      }
      if(cfg.id === 'sqlType' && el.validity.valueMissing) message = 'Wybierz typ źródła SQL.';
      if(cfg.id === 'defaultExportFormat' && el.validity.valueMissing) message = 'Wybierz domyślny format eksportu.';
      errors.push({fieldId: cfg.id, tab: cfg.tab, message});
    }
  });

  const activeFormats = document.querySelectorAll('.fmt-cb:checked');
  if(activeFormats.length === 0){
    errors.push({fieldId:'fmtPdfEnabled', tab:'t10', message:'Wybierz co najmniej jeden aktywny format eksportu (PDF/Excel/CSV).'});
  }

  const exportPatternRules = [
    {toggle:'fmtPdfEnabled', pattern:'pdfFilePattern', ext:'PDF', tab:'t10'},
    {toggle:'fmtExcelEnabled', pattern:'excelFilePattern', ext:'Excel', tab:'t10'},
    {toggle:'fmtCsvEnabled', pattern:'csvFilePattern', ext:'CSV', tab:'t10'}
  ];
  exportPatternRules.forEach(rule=>{
    const toggle = document.getElementById(rule.toggle);
    const patternInput = document.getElementById(rule.pattern);
    if(!toggle || !patternInput || !toggle.checked) return;
    if(!patternInput.value.trim()){
      errors.push({fieldId: rule.pattern, tab: rule.tab, message: `Dla aktywnego formatu ${rule.ext} podaj wzorzec nazwy pliku.`});
    } else if(!patternInput.checkValidity()){
      errors.push({fieldId: rule.pattern, tab: rule.tab, message: `Wzorzec nazwy dla ${rule.ext} musi kończyć się odpowiednim rozszerzeniem.`});
    }
  });

  return errors;
}

function getErrorPriority(error){
  if(!error) return 99;
  if(error.tab === 't1' || error.tab === 't2') return 0;
  if(error.tab === 't10') return 2;
  return 1;
}

function getPrioritySuggestions(errors){
  return [...errors]
    .sort((a,b)=>getErrorPriority(a)-getErrorPriority(b))
    .slice(0,2)
    .map((error, idx)=>({
      ...error,
      title: idx===0 ? 'Najwyższy priorytet' : 'Kolejny krok',
      body: error.message
    }));
}

function updateQuickFixCta(error){
  topPriorityError = error || null;
  const btn = document.getElementById('quickFixCta');
  if(!btn) return;
  if(!error){
    btn.style.display = 'none';
    return;
  }
  btn.style.display = '';
  btn.innerHTML = '<i class="bi bi-magic"></i><span>Przejdź i popraw</span>';
}

function onPriorityCta(tab, fieldId){
  goToField(tab, fieldId);
}

function renderValidationSummary(errors){
  const alertsEl = document.getElementById('sumAlerts');
  if(!alertsEl) return;
  if(!errors.length){
    updateQuickFixCta(null);
    alertsEl.innerHTML = `<div class="sum-alert ok"><i class="bi bi-check-circle"></i><div><strong>Brak błędów walidacji.</strong><div>Gotowe do generacji dokumentacji.</div></div></div>`;
    return;
  }

  const suggestions = getPrioritySuggestions(errors);
  updateQuickFixCta(suggestions[0]);
  const suggestionHtml = suggestions.map(s=>`
    <div class="sum-priority">
      <div class="sum-priority-title">${s.title}</div>
      <div class="sum-priority-body">${s.body}</div>
      <button class="sum-priority-cta" type="button" onclick="onPriorityCta('${s.tab}','${s.fieldId}')"><i class="bi bi-arrow-right-circle"></i>Przejdź i popraw</button>
    </div>
  `).join('');

  const list = errors.map(e=>`<li>${e.message}</li>`).join('');
  alertsEl.innerHTML = `
    <div class="sum-priority-wrap">${suggestionHtml}</div>
    <div class="sum-priority-rules">
      <strong>Reguły priorytetyzacji</strong>
      <ul>
        <li>Wymagane pola z zakładek t1/t2 są najwyżej.</li>
        <li>Błędy eksportu i formatów są obsługiwane niżej.</li>
      </ul>
    </div>
    <div class="sum-alert warn"><i class="bi bi-exclamation-triangle"></i><div><div><strong>Popraw poniższe błędy:</strong></div><ul class="sum-alert-list">${list}</ul></div></div>
  `;
}

function clearCurrentSection(){
  const tab = document.getElementById(currentTab);
  if(!tab) return;
  tab.querySelectorAll('input,textarea,select').forEach(el=>{
    if(el.type === 'button' || el.type === 'submit' || el.type === 'reset' || el.disabled) return;
    if(el.type === 'checkbox' || el.type === 'radio'){
      el.checked = false;
    }else if(el.tagName === 'SELECT'){
      el.selectedIndex = 0;
    }else{
      el.value = '';
    }
    el.dispatchEvent(new Event('input',{bubbles:true}));
    el.dispatchEvent(new Event('change',{bubbles:true}));
  });
  clearValidationErrors();
  showToast('Wyczyszczono bieżącą sekcję.','success');
}

function jumpToErrors(){
  const errors = getValidationErrors();
  renderValidationSummary(errors);
  if(!errors.length){
    showToast('Brak błędów walidacji.','success');
    return;
  }
  if(!summaryOpen) toggleSummary(true);
  const first = errors[0];
  goTab(first.tab);
  const firstField = document.getElementById(first.fieldId);
  if(firstField) firstField.focus({preventScroll:false});
  showToast(`Znaleziono błędy: ${errors.length}.`, 'warning');
}

function buildClipboardSummary(){
  const progress = document.getElementById('progressLabel')?.textContent?.trim() || '0% gotowe';
  const reportName = document.getElementById('rName')?.value?.trim() || '—';
  const reportTitle = document.getElementById('rTitle')?.value?.trim() || '—';
  const sourceType = document.getElementById('sqlType')?.value || '—';
  const defaultFormat = document.getElementById('defaultExportFormat')?.value || '—';
  const errors = getValidationErrors();
  return [
    'Podsumowanie definicji raportu',
    `Postęp: ${progress}`,
    `Nazwa raportu: ${reportName}`,
    `Tytuł: ${reportTitle}`,
    `Typ źródła SQL: ${sourceType}`,
    `Domyślny format eksportu: ${defaultFormat}`,
    `Liczba błędów walidacji: ${errors.length}`
  ].join('\n');
}

async function copySummaryToClipboard(){
  const payload = buildClipboardSummary();
  if(!navigator.clipboard || !navigator.clipboard.writeText){
    showToast('Schowek niedostępny w tej przeglądarce.','warning');
    return;
  }
  try{
    await navigator.clipboard.writeText(payload);
    showToast('Skopiowano podsumowanie do schowka.','success');
  }catch(_err){
    showToast('Nie udało się skopiować podsumowania.','warning');
  }
}

function validateBeforeSubmit(){
  clearValidationErrors();
  const errors = getValidationErrors();

  errors.forEach(err=>showFieldError(err.fieldId, err.message));
  renderValidationSummary(errors);

  if(errors.length){
    if(!summaryOpen) toggleSummary();
    const first = getPrioritySuggestions(errors)[0] || errors[0];
    goToField(first.tab, first.fieldId);
    showToast('Uzupełnij wymagane pola przed generowaniem dokumentacji.','warning');
    return false;
  }

  showToast('Dokumentacja wygenerowana!','success');
  return true;
}

// ── TOAST ──
function showToast(msg, type=''){
  const c=document.getElementById('toastContainer');
  const t=document.createElement('div');
  t.className=`toast ${type}`;
  const icon=document.createElement('i');
  icon.className=`bi bi-${type==='success'?'check-circle':type==='warning'?'exclamation-triangle':'info-circle'}`;
  t.appendChild(icon);
  t.append(document.createTextNode(msg));
  c.appendChild(t);
  setTimeout(()=>{ t.classList.add('removing'); setTimeout(()=>t.remove(),250); }, 2500);
}

document.querySelectorAll('button:not([type])').forEach(btn=>{ btn.type = 'button'; });

// ── INPUT CHANGE LISTENER ──
document.addEventListener('input', e=>{
  if(e.target.matches('input,textarea,select')) scheduleUpdate();
});
document.addEventListener('change', e=>{
  if(e.target.matches('input,textarea,select')) scheduleUpdate();
});

document.addEventListener('keydown', e=>{
  if(e.key === 'Escape' && summaryOpen) toggleSummary(false);
});

// ── INIT ──
// Add initial filter group
addFilterGroup();
initTheme();
initSummaryCompact();
syncSummaryVisibilityState();
initGlobalTooltips();
// Initial update
setTimeout(updateAll, 300);

// ── ANIMATE CARDS ON TAB SWITCH ──
const tabObs = new MutationObserver(()=>{
  document.querySelectorAll('.tab-pane.active .card').forEach((c,i)=>{
    c.style.animationDelay = (i*0.05)+'s';
    c.style.animation='none'; c.offsetHeight;
    c.style.animation='';
  });
});
document.querySelectorAll('.tab-pane').forEach(p=>tabObs.observe(p,{attributes:true,attributeFilter:['class']}));

// ── INPUT FILL TRACKING ──
document.querySelectorAll('input[type=text],textarea').forEach(el=>{
  el.addEventListener('input', ()=>{ el.classList.toggle('filled', el.value.trim().length>0); });
});
</script>
</body>
</html>
